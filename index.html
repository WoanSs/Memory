<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Memory Pro</title>
    
    <!-- C·∫§U H√åNH LOGO & M√ÄU S·∫ÆC -->
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMjU2M2ViIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTEzIDEwVjNMNCAxNGg3djdsOS0xMWgtN3oiLz48L3N2Zz4=">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['Roboto Mono', 'monospace'] },
                    colors: { primary: { 600: '#2563eb', 700: '#1d4ed8' } },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'width': 'width 1s linear forwards',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        width: { 'from': { width: '100%' }, 'to': { width: '0%' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } }
                    },
                    gridTemplateColumns: {
                        '20': 'repeat(20, minmax(0, 1fr))',
                        '40': 'repeat(40, minmax(0, 1fr))',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #334155; touch-action: manipulation; }
        .number-box { transition: all 0.1s; -webkit-appearance: none; border-radius: 4px; }
        .number-box:focus { border-color: #2563eb; box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2); outline: none; background-color: #fff; z-index: 10; transform: scale(1.1); }
        .char-correct { color: #15803d; font-weight: 700; }
        .char-incorrect { color: #b91c1c; text-decoration: line-through; opacity: 0.8; }
        .char-missing { background-color: #fef3c7; color: #b45309; }
        .blur-content { opacity: 0.15; filter: blur(5px); user-select: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .circle-progress { transition: stroke-dashoffset 1s linear; }
    </style>
</head>
<body class="antialiased pb-10 min-h-screen flex flex-col">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 h-14 flex-none shadow-sm">
        <div class="container mx-auto px-4 h-full flex items-center justify-between max-w-4xl">
            <div class="flex items-center gap-2 cursor-pointer active:opacity-70" onclick="window.location.reload()">
                <div class="bg-primary-600 text-white p-1.5 rounded-lg shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </div>
                <span class="font-bold text-slate-800 text-lg tracking-tight">Memory<span class="text-primary-600">Pro</span></span>
            </div>
        </div>
    </nav>

    <main id="app" class="container mx-auto px-2 py-4 max-w-4xl flex-1 flex flex-col"></main>

    <script>
        // --- STATE ---
        let activeView = 'home'; 
        
        // State cho Ph·∫£n X·∫° Nhanh (SM)
        let sm = { data: [], input: [], count: 2, streak: 0, best: parseInt(localStorage.getItem('best_sm')||0) }; // B·∫Øt ƒë·∫ßu count = 2
        let smTimer = null;
        let smFeedback = '';
        let smShow = false;
        let smCountdown = 10; // GI·ªÆ NGUY√äN 10 GI√ÇY
        let smCountdownTimer = null;
        let smCountdownActive = false;

        // State cho D·ªØ Li·ªáu L·ªõn (LM)
        let lm = { lines: [], inputs: [], mask: {}, config: { mem: 5, ans: 5, cnt: 2 }, timer: 0, timerId: null };
        let lmCountdown = 10;
        let lmCountdownTimer = null;
        let lmCountdownActive = false;
        
        const app = document.getElementById('app');
        const fmtTime = s => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
        
        // --- RENDERER ---
        function render() {
            let html = '';

            if(activeView === 'home') {
                html = `
                <div class="grid gap-4 md:grid-cols-2 animate-fade-in mt-2 px-2">
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm active:scale-95 transition-transform cursor-pointer" onclick="startSM()">
                        <div class="w-14 h-14 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-3xl mb-4 shadow-inner">‚ö°</div>
                        <h2 class="text-xl font-bold text-slate-800">Ph·∫£n X·∫° Nhanh</h2>
                        <p class="text-slate-500 text-sm mt-1 mb-4">Luy·ªán nh·ªõ s·ªë nhanh.</p>
                        <div class="text-xs font-bold text-slate-400 uppercase bg-slate-50 inline-block px-2 py-1 rounded">K·ª∑ l·ª•c: ${sm.best}</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm active:scale-95 transition-transform cursor-pointer" onclick="configLM()">
                        <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-3xl mb-4 shadow-inner">üß†</div>
                        <h2 class="text-xl font-bold text-slate-800">D·ªØ Li·ªáu L·ªõn</h2>
                        <p class="text-slate-500 text-sm mt-1 mb-4">Luy·ªán nh·ªõ s·ªë l∆∞·ª£ng l·ªõn.</p>
                        <div class="text-xs font-bold text-slate-400 uppercase bg-slate-50 inline-block px-2 py-1 rounded">Ch·∫ø ƒë·ªô Pro</div>
                    </div>
                </div>`;
            }

            else if(activeView === 'sm_play') {
                if(smCountdownActive) {
                    const radius = 88;
                    const circumference = 2 * Math.PI * radius; 
                    const offset = circumference * (1 - smCountdown/10); // T√≠nh to√°n d·ª±a tr√™n 10 gi√¢y

                    html = `
                    <div class="flex-1 flex flex-col items-center justify-center min-h-[60vh] px-4 animate-fade-in">
                        <div class="text-slate-400 text-xs font-bold uppercase mb-8 tracking-[0.2em]">CHU·∫®N B·ªä</div>
                        <div class="relative w-48 h-48 mb-8">
                            <svg class="w-full h-full transform -rotate-90">
                                <circle cx="96" cy="96" r="${radius}" stroke="#e2e8f0" stroke-width="8" fill="none"/>
                                <circle cx="96" cy="96" r="${radius}" stroke="#2563eb" stroke-width="8" fill="none" 
                                        stroke-linecap="round"
                                        stroke-dasharray="${circumference}" 
                                        stroke-dashoffset="${offset}"
                                        class="circle-progress"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="text-7xl font-black text-slate-800 tabular-nums">${smCountdown}</span>
                            </div>
                        </div>
                        <p class="text-slate-500 text-sm font-medium animate-pulse">Tr√≤ ch∆°i b·∫Øt ƒë·∫ßu sau ${smCountdown} gi√¢y...</p>
                        <button onclick="skipSMCountdown()" class="mt-8 text-slate-400 text-xs font-bold uppercase hover:text-primary-600">B·ªè qua >></button>
                    </div>`;
                }
                else if(smShow) {
                    let textSize = 'text-7xl'; 
                    // ƒêi·ªÅu ch·ªânh size ch·ªØ v√¨ s·ªë l∆∞·ª£ng tƒÉng nhanh
                    if(sm.count > 20) textSize = 'text-2xl';
                    else if(sm.count > 12) textSize = 'text-4xl';
                    else if(sm.count > 8) textSize = 'text-5xl'; 

                    const displayRows = [];
                    // Ng·∫Øt d√≤ng m·ªói 10 s·ªë ƒë·ªÉ d·ªÖ nh√¨n tr√™n mobile
                    for(let i=0; i < sm.data.length; i+=10) {
                        displayRows.push(sm.data.slice(i, i+10).join(''));
                    }
                    const displayHtml = displayRows.map(row => `<div>${row}</div>`).join('');

                    // Th·ªùi gian hi·ªÉn th·ªã
                    const duration = Math.max(1.5, sm.count * 0.7);

                    html = `
                    <div class="flex-1 flex flex-col items-center justify-center min-h-[60vh] px-4">
                        <div class="text-slate-400 text-xs font-bold uppercase mb-8 tracking-[0.2em]">GHI NH·ªö (${sm.count} S·ªê)</div>
                        <div class="${textSize} font-mono font-bold text-slate-800 tracking-widest select-none drop-shadow-sm text-center w-full break-words leading-relaxed flex flex-col gap-2">
                            ${displayHtml}
                        </div>
                        <div class="mt-12 w-48 h-1.5 bg-slate-200 rounded-full overflow-hidden flex-none">
                            <div class="h-full bg-primary-600 animate-[width_linear_forwards]" style="width:100%; animation-duration:${duration}s"></div>
                        </div>
                    </div>`;
                } 
                else {
                    let fbHtml = '';
                    if(smFeedback === 'correct') fbHtml = `<div class="mt-8 p-4 bg-green-100 text-green-700 rounded-xl font-bold text-center animate-bounce">‚ú® Ch√≠nh x√°c! (+2 s·ªë)</div>`;
                    else if(smFeedback) fbHtml = `
                        <div class="mt-8 p-6 bg-white border border-red-100 shadow-lg rounded-2xl text-center animate-shake">
                            <div class="text-red-600 font-bold text-lg mb-1">Sai r·ªìi!</div>
                            <div class="text-slate-400 text-sm">ƒê√°p √°n: <span class="font-mono font-bold text-slate-800 text-xl break-all">${smFeedback.split(':')[1]}</span></div>
                            <button onclick="startSM()" class="mt-4 px-6 py-2 bg-slate-800 text-white rounded-lg font-bold active:bg-slate-900">Th·ª≠ l·∫°i</button>
                        </div>`;

                    const inputs = Array(sm.count).fill('').map((_, i) => `
                        <input data-type="sm" data-idx="${i}" value="${sm.input[i]||''}" type="tel" pattern="[0-9]*" maxlength="1" 
                        ${i===0 ? 'autofocus' : ''} 
                        class="number-box w-full aspect-[3/4] text-xl md:text-3xl text-center font-bold bg-slate-50 border border-slate-200 text-slate-800 placeholder-transparent caret-primary-600 focus:z-10"
                        ${smFeedback?'disabled':''}>
                    `).join('');

                    html = `
                    <div class="max-w-4xl mx-auto w-full mt-4 px-4">
                        <div class="flex justify-between items-center mb-6">
                            <button onclick="goHome()" class="text-slate-400 font-bold text-sm hover:text-slate-600">‚Üê Tho√°t</button>
                            <span class="text-xs font-bold bg-white border px-3 py-1 rounded-full text-slate-500">Level ${sm.count} s·ªë</span>
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-8 flex flex-col items-center">
                            <p class="text-slate-400 text-xs font-bold uppercase mb-6 tracking-wider">Nh·∫≠p d√£y s·ªë</p>
                            <div class="grid grid-cols-8 md:grid-cols-10 gap-1.5 md:gap-3 w-full max-w-3xl">
                                ${inputs}
                            </div>
                            ${fbHtml}
                        </div>
                    </div>`;
                }
            }
            
            // --- C√ÅC VIEW C·ª¶A PH·∫¶N D·ªÆ LI·ªÜU L·ªöN ---
            else if(activeView === 'lm_cfg') {
                 html = `
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 max-w-md mx-auto mt-6 px-6">
                    <h2 class="text-xl font-bold text-slate-800 mb-6">C·∫•u h√¨nh b√†i t·∫≠p</h2>
                    <div class="space-y-5">
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-2">Th·ªùi gian nh·ªõ (ph√∫t)</label><input id="lm-mem" type="number" value="5" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800 focus:border-primary-600 outline-none text-lg"></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-2">Th·ªùi gian tr·∫£ l·ªùi (ph√∫t)</label><input id="lm-ans" type="number" value="5" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800 focus:border-primary-600 outline-none text-lg"></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-2">S·ªë d√≤ng (40 s·ªë/d√≤ng)</label><input id="lm-cnt" type="number" value="2" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800 focus:border-primary-600 outline-none text-lg"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-8">
                        <button onclick="goHome()" class="py-3 rounded-xl font-bold text-slate-600 bg-slate-50 hover:bg-slate-100">H·ªßy</button>
                        <button onclick="startLM()" class="py-3 rounded-xl font-bold text-white bg-primary-600 hover:bg-primary-700 shadow-md shadow-blue-200">B·∫Øt ƒë·∫ßu</button>
                    </div>
                </div>`;
            }
            else if(activeView === 'lm_countdown') {
                const radius = 88;
                const circumference = 2 * Math.PI * radius; 
                const offset = circumference * (1 - lmCountdown/10);

                html = `
                <div class="flex-1 flex flex-col items-center justify-center min-h-[60vh] px-4 animate-fade-in">
                    <div class="text-slate-400 text-xs font-bold uppercase mb-8 tracking-[0.2em]">CHU·∫®N B·ªä</div>
                    <div class="relative w-48 h-48 mb-8">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="96" cy="96" r="${radius}" stroke="#e2e8f0" stroke-width="8" fill="none"/>
                            <circle cx="96" cy="96" r="${radius}" stroke="#2563eb" stroke-width="8" fill="none" 
                                    stroke-linecap="round"
                                    stroke-dasharray="${circumference}" 
                                    stroke-dashoffset="${offset}"
                                    class="circle-progress"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-7xl font-black text-slate-800 tabular-nums">${lmCountdown}</span>
                        </div>
                    </div>
                    <p class="text-slate-500 text-sm font-medium animate-pulse">B√†i t·∫≠p b·∫Øt ƒë·∫ßu sau ${lmCountdown} gi√¢y...</p>
                    <button onclick="skipLMCountdown()" class="mt-8 text-slate-400 text-xs font-bold uppercase hover:text-primary-600">B·ªè qua >></button>
                </div>`;
            }
            else if(activeView === 'lm_mem') {
                const rows = lm.lines.map((line, i) => `
                    <div class="bg-white rounded-xl border border-slate-200 p-2 mb-2 shadow-sm active:scale-[0.99] transition-transform" onclick="toggleMask(${i})">
                        <div class="flex justify-between items-center mb-1">
                            <span class="bg-slate-100 text-slate-500 px-2 py-0.5 rounded text-[10px] font-bold uppercase">D√≤ng ${i+1}</span>
                            ${lm.mask[i] ? '<span class="text-[10px] font-bold text-slate-400 flex items-center gap-1">üëÅÔ∏è ƒê√£ che</span>' : ''}
                        </div>
                        <div class="w-full overflow-x-auto no-scrollbar">
                            <div id="row-${i}" 
                                 class="font-mono text-[11px] sm:text-sm md:text-xl text-slate-800 leading-tight tracking-[0.15em] whitespace-nowrap 
                                        ${lm.mask[i]?'blur-content':''} transition-all duration-200 select-none pt-1 pb-1">
                                ${line}
                            </div>
                        </div>
                    </div>
                `).join('');

                html = `
                <div class="flex flex-col h-full">
                    <div class="sticky top-0 z-20 bg-[#f8fafc] pb-2 pt-2">
                        <div class="flex gap-2 mb-2 px-1">
                            <div class="bg-white p-3 rounded-2xl border border-slate-200 shadow-sm flex-1 flex justify-between items-center">
                                <div>
                                    <div class="text-[10px] font-bold text-slate-400 uppercase leading-none mb-1">Th·ªùi gian</div>
                                    <div id="timer" class="font-mono text-xl font-bold text-slate-800 leading-none">${fmtTime(lm.timer)}</div>
                                </div>
                                <button onclick="lmPhase2()" class="bg-primary-600 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-sm active:bg-primary-700 whitespace-nowrap">Tr·∫£ l·ªùi</button>
                            </div>
                            <button onclick="goHome()" class="bg-white text-red-500 w-12 rounded-2xl border border-red-100 shadow-sm flex flex-col items-center justify-center active:bg-red-50">
                                <span class="text-xl leading-none">√ó</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 pb-10 space-y-1 overflow-y-auto px-1">${rows}</div>
                </div>`;
            }
            else if(activeView === 'lm_ans') {
                const rows = lm.inputs.map((_, r) => `
                    <div class="bg-white rounded-xl border border-slate-200 p-2 mb-3 shadow-sm">
                        <div class="flex justify-between items-center mb-2 px-1">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">D√≤ng ${r+1}</span>
                            <span id="prog-${r}" class="text-[10px] font-bold text-slate-300">0/40</span>
                        </div>
                        <div class="grid grid-cols-20 md:grid-cols-40 gap-[1px] md:gap-[2px]">
                            ${Array(40).fill('').map((_, c) => `
                                <input data-type="lm" data-r="${r}" data-c="${c}" value="${lm.inputs[r][c]}" type="tel" pattern="[0-9]*" maxlength="1"
                                class="number-box w-full aspect-[2/3] text-center font-mono text-[9px] md:text-sm font-bold bg-slate-50 border border-slate-200 text-slate-900 p-0 focus:z-10 focus:border-primary-600 rounded-none first:rounded-l last:rounded-r">
                            `).join('')}
                        </div>
                    </div>
                `).join('');

                html = `
                <div class="flex flex-col h-full">
                    <div class="sticky top-0 z-20 bg-[#f8fafc] pb-2 pt-2">
                        <div class="flex gap-2 mb-2 px-1">
                            <div class="bg-white p-3 rounded-2xl border border-slate-200 shadow-sm flex-1 flex justify-between items-center">
                                 <div>
                                    <div class="text-[10px] font-bold text-slate-400 uppercase leading-none mb-1">C√≤n l·∫°i</div>
                                    <div id="timer" class="font-mono text-xl font-bold text-slate-800 leading-none">${fmtTime(lm.timer)}</div>
                                </div>
                                <button onclick="lmScore()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-sm active:bg-green-700 whitespace-nowrap">N·ªôp b√†i</button>
                            </div>
                            <button onclick="goHome()" class="bg-white text-red-500 w-12 rounded-2xl border border-red-100 shadow-sm flex flex-col items-center justify-center active:bg-red-50">
                                <span class="text-xl leading-none">√ó</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 pb-10 px-1 overflow-y-auto">${rows}</div>
                </div>`;
            }
            else if(activeView === 'lm_res') {
                let totalC = 0, totalT = 0;
                const details = lm.lines.map((line, i) => {
                    const u = lm.inputs[i].join('');
                    totalT += 40;
                    let ls = 0; 
                    if(i < lm.lines.length - 1) { 
                        let d = Math.abs(line.length - u.length);
                        for(let k=0; k<Math.min(line.length, u.length); k++) if(u[k]!==line[k]) d++;
                        if(d===0) ls=40; else if(d===1) ls=20;
                    } else { 
                        let d = 0, len = u.trim().length;
                        for(let k=0; k<Math.min(len, line.length); k++) if(u[k]!==line[k]) d++;
                        if(d===0 && len>0) ls=len; else if(d===1 && len>0) ls=Math.ceil(len/2);
                    }
                    totalC += ls;

                    let htmlRes = '';
                    for(let k=0; k<line.length; k++) {
                        if(k < u.length) htmlRes += `<span class="${u[k]===line[k]?'char-correct':'char-incorrect'}">${line[k]}</span>`;
                        else htmlRes += `<span class="char-missing">${line[k]}</span>`;
                    }
                    if(u.length > line.length) htmlRes += `<span class="char-incorrect">${u.substring(line.length)}</span>`;

                    return `
                    <div class="bg-white p-4 rounded-xl border border-slate-200 mb-4 shadow-sm">
                        <div class="text-xs font-bold text-slate-500 mb-2 pb-2 border-b border-slate-100 flex justify-between">
                            <span>D√íNG ${i+1}</span>
                            <span class="${ls===40?'text-green-600':'text-slate-400'}">${ls}/40 ƒëi·ªÉm</span>
                        </div>
                        <div class="space-y-3 font-mono text-[11px] sm:text-sm md:text-base">
                            <div>
                                <span class="text-[9px] font-bold text-slate-400 uppercase block mb-1">G·ªëc</span>
                                <div class="text-slate-500 tracking-[0.15em] whitespace-nowrap overflow-x-auto no-scrollbar">
                                    ${line}
                                </div>
                            </div>
                            <div>
                                <span class="text-[9px] font-bold text-slate-400 uppercase block mb-1">B·∫°n</span>
                                <div class="text-slate-800 font-bold tracking-[0.15em] whitespace-nowrap overflow-x-auto no-scrollbar">
                                    ${u||'-'}
                                </div>
                            </div>
                            <div>
                                <span class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Check</span>
                                <div class="bg-slate-50 p-2 rounded border border-slate-100 tracking-[0.15em] whitespace-nowrap overflow-x-auto no-scrollbar leading-none">
                                    ${htmlRes}
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');

                const pct = Math.round((totalC/totalT)*100);
                const color = pct>=50 ? 'text-green-600' : 'text-red-600';

                html = `
                <div class="max-w-3xl mx-auto pb-10 mt-4 px-4">
                    <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm text-center mb-6">
                        <h2 class="text-xs font-bold text-slate-400 uppercase tracking-[0.2em] mb-2">T·ªîNG K·∫æT</h2>
                        <div class="text-6xl font-black ${color} mb-2 tracking-tight">${pct}%</div>
                        <div class="text-slate-500 font-bold text-lg">${totalC} / ${totalT} ƒëi·ªÉm</div>
                        <div class="flex justify-center gap-3 mt-8">
                            <button onclick="goHome()" class="px-6 py-3 border border-slate-200 rounded-xl font-bold text-slate-600 bg-slate-50">Menu</button>
                            <button onclick="startLM()" class="px-6 py-3 bg-primary-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200">L√†m l·∫°i</button>
                        </div>
                    </div>
                    ${details}
                </div>`;
            }

            app.innerHTML = html;
            if(activeView === 'lm_ans') setTimeout(bindInputs, 100);
        }

        // --- LOGIC ---
        function goHome() { 
            stopTimer(); 
            if(smTimer) clearTimeout(smTimer);
            if(smCountdownTimer) clearTimeout(smCountdownTimer);
            if(lmCountdownTimer) clearTimeout(lmCountdownTimer);
            smCountdownActive = false;
            lmCountdownActive = false;
            activeView = 'home'; 
            render(); 
        }
        
        function startSM() { 
            activeView = 'sm_play'; 
            sm.count = 2; 
            sm.streak = 0; 
            smCountdown = 10; // ƒê√É TR·∫¢ V·ªÄ 10 GI√ÇY
            smCountdownActive = true;
            startSMCountdown();
        }

        function startSMCountdown() {
            render();
            if(smCountdown > 0) {
                if(smCountdownTimer) clearTimeout(smCountdownTimer);
                smCountdownTimer = setTimeout(() => {
                    smCountdown--;
                    startSMCountdown();
                }, 1000);
            } else {
                smCountdownActive = false;
                clearTimeout(smCountdownTimer);
                genSM();
            }
        }
        
        function skipSMCountdown() {
            if(smCountdownTimer) clearTimeout(smCountdownTimer);
            smCountdown = 0;
            smCountdownActive = false;
            genSM();
        }

        function genSM() {
            if(smTimer) clearTimeout(smTimer);
            smFeedback=''; smShow=true;
            sm.data = Array.from({length:sm.count}, () => Math.floor(Math.random()*10));
            sm.input = Array(sm.count).fill('');
            render();
            
            const wait = Math.max(1500, sm.count*700);
            smTimer = setTimeout(() => {
                smShow=false; render();
                setTimeout(() => {
                    const el = document.querySelector('input[data-idx="0"]');
                    if(el) { el.focus(); el.click(); }
                }, 150);
            }, wait);
        }
        
        function checkSM() {
            const u = sm.input.join('');
            const r = sm.data.join('');
            if(u===r) {
                smFeedback='correct'; sm.streak++;
                if(sm.streak>sm.best) { sm.best=sm.streak; localStorage.setItem('best_sm', sm.best); }
                render();
                setTimeout(() => { sm.count += 2; genSM(); }, 1000);
            } else {
                smFeedback=`:${r}`; sm.streak=0; render();
            }
        }

        // Logic ph·∫ßn LM gi·ªØ nguy√™n
        function configLM() { activeView='lm_cfg'; render(); }
        function startLM() {
            lm.config.mem = parseInt(document.getElementById('lm-mem').value)||5;
            lm.config.ans = parseInt(document.getElementById('lm-ans').value)||5;
            lm.config.cnt = parseInt(document.getElementById('lm-cnt').value)||2;
            lm.lines = Array(lm.config.cnt).fill().map(() => Array.from({length:40}, ()=>Math.floor(Math.random()*10)).join(''));
            lm.mask = {};
            activeView = 'lm_countdown';
            lmCountdown = 10;
            lmCountdownActive = true;
            startLMCountdown();
        }

        function startLMCountdown() {
            render();
            if(lmCountdown > 0) {
                if(lmCountdownTimer) clearTimeout(lmCountdownTimer);
                lmCountdownTimer = setTimeout(() => {
                    lmCountdown--;
                    startLMCountdown();
                }, 1000);
            } else {
                lmCountdownActive = false;
                clearTimeout(lmCountdownTimer);
                beginLMMemoryPhase();
            }
        }

        function skipLMCountdown() {
            if(lmCountdownTimer) clearTimeout(lmCountdownTimer);
            lmCountdown = 0;
            lmCountdownActive = false;
            beginLMMemoryPhase();
        }

        function beginLMMemoryPhase() {
            activeView = 'lm_mem';
            lm.timer = lm.config.mem * 60;
            startTimer(() => { lmPhase2(); });
            render();
        }

        function toggleMask(i) {
            lm.mask[i] = !lm.mask[i];
            const el = document.getElementById(`row-${i}`);
            if(el) { el.classList.toggle('blur-content'); render(); }
        }
        function lmPhase2() {
            stopTimer();
            activeView = 'lm_ans';
            lm.inputs = Array(lm.config.cnt).fill().map(()=>Array(40).fill(''));
            lm.timer = lm.config.ans * 60;
            startTimer(() => { lmScore(); });
            render();
        }
        function lmScore() { stopTimer(); activeView = 'lm_res'; render(); }

        function startTimer(cb) {
            if(lm.timerId) clearInterval(lm.timerId);
            lm.timerId = setInterval(() => {
                lm.timer--;
                const el = document.getElementById('timer');
                if(el) {
                    el.innerText = fmtTime(lm.timer);
                    if(lm.timer < 60) el.classList.add('text-red-600');
                }
                if(lm.timer <= 0) { stopTimer(); cb(); }
            }, 1000);
        }
        function stopTimer() { if(lm.timerId) clearInterval(lm.timerId); }
        function bindInputs() {}

        // Global Event Listeners
        document.addEventListener('input', e => {
            const t = e.target;
            if(t.dataset.type === 'sm') {
                const i = parseInt(t.dataset.idx);
                sm.input[i] = t.value;
                if(t.value && i < sm.count-1) document.querySelector(`input[data-idx="${i+1}"]`).focus();
                if(sm.input.join('').length === sm.count) checkSM();
            }
            if(t.dataset.type === 'lm') {
                const r = parseInt(t.dataset.r), c = parseInt(t.dataset.c);
                lm.inputs[r][c] = t.value;
                const f = lm.inputs[r].filter(x=>x).length;
                const p = document.getElementById(`prog-${r}`);
                if(p) { p.innerText = `${f}/40`; p.className = f===40?'text-[10px] font-bold text-green-600':'text-[10px] font-bold text-slate-300'; }
                if(t.value) {
                    if(c < 39) document.querySelector(`input[data-r="${r}"][data-c="${c+1}"]`)?.focus();
                    else document.querySelector(`input[data-r="${r+1}"][data-c="0"]`)?.focus();
                }
            }
        });

        render();
    </script>
</body>
</html>
