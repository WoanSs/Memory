<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Master Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Space Mono', 'monospace'],
                    },
                    colors: {
                        brand: { 500: '#6366f1', 600: '#4f46e5' },
                        accent: { 500: '#ec4899', 600: '#db2777' }
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Animated Background */
        body {
            background-color: #f0f9ff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .number-box {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .number-box:focus {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.2);
            border-color: #6366f1;
            outline: none;
            background: #fff;
        }

        /* Typography for Numbers */
        .font-digit { font-family: 'Space Mono', monospace; letter-spacing: -0.02em; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Utilities */
        .blur-content { filter: blur(8px); opacity: 0.3; user-select: none; }
        .char-correct { color: #10b981; font-weight: bold; }
        .char-incorrect { color: #ef4444; text-decoration: line-through; opacity: 0.7; }
        .char-missing { background-color: #fef3c7; color: #d97706; padding: 0 2px; border-radius: 2px; }
    </style>
</head>
<body class="text-slate-800 relative selection:bg-indigo-100 selection:text-indigo-700">

    <!-- Background Blobs Decoration -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-purple-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
        <div class="absolute top-0 right-1/4 w-96 h-96 bg-blue-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-32 left-1/3 w-96 h-96 bg-pink-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000"></div>
    </div>

    <!-- Navbar -->
    <nav class="sticky top-4 z-50 px-4 mb-8">
        <div class="glass-panel container mx-auto max-w-5xl h-16 rounded-2xl flex items-center justify-between px-6 shadow-sm/50">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="window.location.reload()">
                <div class="w-10 h-10 bg-gradient-to-br from-brand-500 to-brand-600 text-white rounded-xl flex items-center justify-center shadow-lg shadow-brand-500/30 group-hover:scale-105 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
                </div>
                <div>
                    <h1 class="font-bold text-lg tracking-tight text-slate-900">Brain<span class="text-brand-600">Train</span></h1>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Pro Edition</p>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="app-content" class="container mx-auto px-4 pb-12 max-w-5xl"></main>

    <script>
        // --- STATE MANAGEMENT ---
        let activeType = 'none'; 

        // Short Memory
        let shortData = { nums: [], input: [], digit: 1, streak: 0, best: parseInt(localStorage.getItem('best_s')||0) };
        let shortTimer = null;
        let shortFeedback = '';
        let showShort = false;

        // Long Memory
        let longData = { lines: [], input: [], score: {c:0, t:0}, mask: {} };
        let longConfig = { mem: 5, ans: 5, count: 2 };
        let timer = { val: 0, id: null };

        const app = document.getElementById('app-content');

        // --- UTILS ---
        const fmtTime = s => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
        const grp2 = s => s ? s.match(/.{1,2}/g).join(' ') : '';

        // --- ACTIONS ---
        function init() { render(); }

        // Short Memory Actions
        function startShort() {
            activeType = 'short';
            shortData.digit = 1;
            shortData.streak = 0;
            genShort();
        }
        function genShort() {
            clearTimeout(shortTimer);
            shortFeedback = '';
            shortData.input = Array(shortData.digit).fill('');
            shortData.nums = Array.from({length: shortData.digit}, () => Math.floor(Math.random()*10));
            showShort = true;
            render();

            // Time calculation: 1s base + 0.6s per digit
            const wait = Math.max(1200, shortData.digit * 650);
            shortTimer = setTimeout(() => {
                showShort = false;
                render();
                setTimeout(() => document.querySelector('input[data-i="0"]')?.focus(), 50);
            }, wait);
        }
        function checkShort() {
            const u = shortData.input.join('');
            const r = shortData.nums.join('');
            if(u === r) {
                shortFeedback = 'correct';
                shortData.streak++;
                if(shortData.streak > shortData.best) {
                    shortData.best = shortData.streak;
                    localStorage.setItem('best_s', shortData.best);
                }
                setTimeout(() => { shortData.digit++; genShort(); }, 1000);
            } else {
                shortFeedback = `incorrect:${r}`;
                shortData.streak = 0;
            }
            render();
        }

        // Long Memory Actions
        function configLong() { activeType = 'longCfg'; render(); }
        function startLong() {
            longConfig.mem = parseInt(document.getElementById('i-mem').value);
            longConfig.ans = parseInt(document.getElementById('i-ans').value);
            longConfig.count = parseInt(document.getElementById('i-cnt').value);
            
            longData.lines = Array(longConfig.count).fill().map(() => 
                Array.from({length:40}, () => Math.floor(Math.random()*10)).join('')
            );
            longData.mask = {};
            
            activeType = 'longMem';
            timer.val = longConfig.mem * 60;
            runTimer(() => { activeType = 'longAns'; prepAns(); });
            render();
        }
        function prepAns() {
            longData.input = Array(longConfig.count).fill().map(() => Array(40).fill(''));
            timer.val = longConfig.ans * 60;
            runTimer(() => scoreLong());
            render();
            setTimeout(bindNav, 100);
        }
        function scoreLong() {
            clearInterval(timer.id);
            let earn = 0, poss = 0;
            longData.lines.forEach((row, i) => {
                poss += 40;
                const u = longData.input[i].join('');
                let lineS = 0;
                if(i < longData.lines.length - 1) {
                    let d = Math.abs(row.length - u.length);
                    for(let k=0; k<Math.min(row.length, u.length); k++) if(u[k]!==row[k]) d++;
                    if(d===0) lineS=40; else if(d===1) lineS=20;
                } else {
                    let d = 0, len = u.trim().length;
                    for(let k=0; k<Math.min(len, row.length); k++) if(u[k]!==row[k]) d++;
                    if(d===0 && len>0) lineS=len; else if(d===1 && len>0) lineS=Math.ceil(len/2);
                }
                earn += lineS;
            });
            longData.score = {c: earn, t: poss};
            activeType = 'longRes';
            render();
        }
        function toggleMask(i) {
            longData.mask[i] = !longData.mask[i];
            const el = document.getElementById(`r-${i}`);
            const ic = document.getElementById(`icon-${i}`);
            if(longData.mask[i]) {
                el.classList.add('blur-content');
                ic.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />`;
            } else {
                el.classList.remove('blur-content');
                ic.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />`;
            }
        }
        function runTimer(cb) {
            if(timer.id) clearInterval(timer.id);
            timer.id = setInterval(() => {
                timer.val--;
                const el = document.getElementById('timer-txt');
                if(el) {
                    el.innerText = fmtTime(timer.val);
                    if(timer.val<60) el.classList.add('text-red-500', 'animate-pulse');
                }
                if(timer.val <= 0) { clearInterval(timer.id); cb(); }
            }, 1000);
        }
        function stop() {
            clearTimeout(shortTimer);
            clearInterval(timer.id);
            activeType = 'none';
            render();
        }

        // --- RENDERER ---
        function render() {
            let html = '';
            
            // 1. DASHBOARD
            if(activeType === 'none') {
                html = `
                <div class="grid md:grid-cols-2 gap-8 animate-fade-in">
                    <!-- Card 1 -->
                    <div class="glass-panel rounded-3xl p-8 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group cursor-pointer relative overflow-hidden" onclick="startShort()">
                        <div class="absolute top-0 right-0 p-32 bg-blue-500/5 rounded-full blur-2xl -mr-16 -mt-16"></div>
                        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-400 to-blue-600 text-white flex items-center justify-center text-3xl shadow-lg shadow-blue-500/30 mb-6 group-hover:scale-110 transition-transform">‚ö°</div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Ph·∫£n X·∫° Nhanh</h2>
                        <p class="text-slate-500 font-medium mb-6 leading-relaxed">R√®n luy·ªán kh·∫£ nƒÉng ghi nh·ªõ t·ª©c th√¨ (Short-term Memory) v·ªõi chu·ªói s·ªë ng·∫´u nhi√™n.</p>
                        <div class="flex items-center justify-between pt-6 border-t border-slate-200/50">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-widest">K·ª∑ l·ª•c: <span class="text-blue-600 text-base">${shortData.best}</span></div>
                            <span class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors">‚ûú</span>
                        </div>
                    </div>
                    <!-- Card 2 -->
                    <div class="glass-panel rounded-3xl p-8 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group cursor-pointer relative overflow-hidden" onclick="configLong()">
                         <div class="absolute top-0 right-0 p-32 bg-purple-500/5 rounded-full blur-2xl -mr-16 -mt-16"></div>
                        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-400 to-purple-600 text-white flex items-center justify-center text-3xl shadow-lg shadow-purple-500/30 mb-6 group-hover:scale-110 transition-transform">üß†</div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">D·ªØ Li·ªáu L·ªõn</h2>
                        <p class="text-slate-500 font-medium mb-6 leading-relaxed">Th·ª≠ th√°ch v·ªõi ma tr·∫≠n 40 s·ªë/d√≤ng. H·ªó tr·ª£ Masking, Auto-jump v√† Ch·∫•m ƒëi·ªÉm chi ti·∫øt.</p>
                        <div class="flex items-center justify-between pt-6 border-t border-slate-200/50">
                             <div class="text-xs font-bold text-slate-400 uppercase tracking-widest">Ch·∫ø ƒë·ªô: Pro</div>
                             <span class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition-colors">‚ûú</span>
                        </div>
                    </div>
                </div>`;
            }

            // 2. SHORT MEMORY
            else if(activeType === 'short') {
                if(showShort) {
                    html = `
                    <div class="glass-panel rounded-3xl shadow-2xl p-12 min-h-[60vh] flex flex-col justify-center items-center relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-transparent pointer-events-none"></div>
                        <p class="text-blue-500 text-sm font-black uppercase tracking-[0.3em] mb-8 animate-pulse">GHI NH·ªö CHU·ªñI S·ªê</p>
                        <div class="font-digit text-8xl md:text-9xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-slate-700 to-slate-900 drop-shadow-sm tracking-wider select-none">
                            ${shortData.nums.join('')}
                        </div>
                         <div class="mt-16 w-64 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-500 animate-[width_linear] transition-all duration-[${Math.max(1, shortData.digit*0.6)}s]" style="width:0%"></div>
                        </div>
                    </div>`;
                } else {
                    const inputs = Array(shortData.digit).fill('').map((_, i) => `
                        <input data-i="${i}" value="${shortData.input[i]||''}" type="text" inputmode="numeric" maxlength="1"
                        class="number-box w-14 h-20 text-4xl text-center font-bold rounded-xl border-2 border-white bg-white/50 shadow-sm text-slate-700 placeholder-slate-300 focus:ring-4 focus:ring-blue-100 focus:border-blue-500" 
                        ${shortFeedback?'disabled':''}>
                    `).join('');
                    
                    let msg = '';
                    if(shortFeedback === 'correct') msg = `<div class="mt-8 p-4 bg-green-100 text-green-700 rounded-2xl font-bold inline-flex items-center gap-2 animate-bounce"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Tuy·ªát v·ªùi! Chu·∫©n b·ªã ti·∫øp theo...</div>`;
                    else if(shortFeedback) msg = `
                        <div class="mt-8 p-6 bg-white rounded-2xl shadow-lg border border-red-100 animate-shake text-center">
                            <div class="text-red-500 font-bold text-xl mb-1">Sai r·ªìi!</div>
                            <div class="text-slate-400 text-sm mb-3">ƒê√°p √°n ƒë√∫ng l√†</div>
                            <div class="font-digit text-3xl font-bold text-slate-800 tracking-widest">${shortFeedback.split(':')[1]}</div>
                            <button onclick="startShort()" class="mt-4 px-6 py-2 bg-slate-800 text-white rounded-lg font-bold hover:bg-slate-900 transition-colors">Th·ª≠ l·∫°i</button>
                        </div>`;

                    html = `
                    <div class="max-w-4xl mx-auto text-center">
                        <button onclick="stop()" class="mb-6 text-slate-400 hover:text-slate-600 font-bold flex items-center gap-2 mx-auto transition-colors">‚Üê Quay l·∫°i Dashboard</button>
                        <div class="glass-panel rounded-3xl p-10 min-h-[50vh] flex flex-col items-center justify-center">
                            <div class="text-slate-400 font-bold mb-8 uppercase tracking-widest text-xs">Nh·∫≠p l·∫°i d√£y s·ªë b·∫°n v·ª´a th·∫•y</div>
                            <div class="flex flex-wrap justify-center gap-3">${inputs}</div>
                            ${msg}
                        </div>
                    </div>`;
                }
            }

            // 3. CONFIG LONG
            else if(activeType === 'longCfg') {
                html = `
                <div class="max-w-md mx-auto mt-10">
                    <div class="glass-panel rounded-3xl p-8 shadow-xl relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-500 to-accent-500"></div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-6">C·∫•u h√¨nh b√†i t·∫≠p</h2>
                        <div class="space-y-5">
                            <div><label class="text-sm font-bold text-slate-500 ml-1 mb-1 block">Th·ªùi gian nh·ªõ (ph√∫t)</label><input id="i-mem" type="number" value="5" class="w-full p-3 rounded-xl bg-white/50 border border-white shadow-sm focus:ring-2 focus:ring-brand-500 outline-none font-bold text-slate-700"></div>
                            <div><label class="text-sm font-bold text-slate-500 ml-1 mb-1 block">Th·ªùi gian tr·∫£ l·ªùi (ph√∫t)</label><input id="i-ans" type="number" value="5" class="w-full p-3 rounded-xl bg-white/50 border border-white shadow-sm focus:ring-2 focus:ring-brand-500 outline-none font-bold text-slate-700"></div>
                            <div><label class="text-sm font-bold text-slate-500 ml-1 mb-1 block">S·ªë d√≤ng (40 s·ªë/d√≤ng)</label><input id="i-cnt" type="number" value="2" class="w-full p-3 rounded-xl bg-white/50 border border-white shadow-sm focus:ring-2 focus:ring-brand-500 outline-none font-bold text-slate-700"></div>
                        </div>
                        <div class="flex gap-3 mt-8">
                            <button onclick="stop()" class="flex-1 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-100 transition-colors">H·ªßy</button>
                            <button onclick="startLong()" class="flex-1 py-3 rounded-xl font-bold text-white bg-gradient-to-r from-brand-600 to-brand-500 shadow-lg shadow-brand-500/30 hover:shadow-brand-500/50 hover:scale-[1.02] transition-all">B·∫Øt ƒë·∫ßu</button>
                        </div>
                    </div>
                </div>`;
            }

            // 4. MEMORY PHASE
            else if(activeType === 'longMem') {
                const grid = longData.lines.map((l, i) => `
                    <div class="group relative bg-white/40 hover:bg-white/80 border border-white/60 rounded-2xl p-5 mb-3 transition-all duration-200 cursor-pointer hover:shadow-md flex items-start" onclick="toggleMask(${i})">
                        <div class="w-8 h-8 rounded-full bg-white text-brand-600 flex items-center justify-center font-bold text-sm shadow-sm mr-4 shrink-0">${i+1}</div>
                        <div id="r-${i}" class="font-digit text-xl md:text-2xl text-slate-700 break-all leading-relaxed tracking-wide transition-all duration-300">${grp2(l)}</div>
                        <div class="absolute top-3 right-3 text-slate-300 group-hover:text-brand-400 transition-colors">
                            <svg id="icon-${i}" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                        </div>
                    </div>
                `).join('');
                
                html = `
                <div class="glass-panel rounded-3xl h-[85vh] flex flex-col shadow-2xl overflow-hidden">
                    <div class="p-4 border-b border-white/50 bg-white/30 flex justify-between items-center backdrop-blur-md z-10">
                        <div class="flex items-center gap-3">
                            <span class="px-3 py-1 rounded-full bg-brand-100 text-brand-700 text-xs font-black uppercase tracking-wider">GHI NH·ªö</span>
                            <span class="text-xs font-bold text-slate-400 hidden sm:block">TIP: Click v√†o d√≤ng ƒë·ªÉ che</span>
                        </div>
                        <div id="timer-txt" class="font-digit text-2xl font-bold text-slate-700">${fmtTime(timer.val)}</div>
                        <button onclick="activeType='longAns'; prepAns();" class="px-5 py-2 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-50 shadow-sm transition-all">Tr·∫£ l·ªùi ngay ‚ûú</button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-2 custom-scrollbar">${grid}</div>
                </div>`;
            }

            // 5. ANSWER PHASE
            else if(activeType === 'longAns') {
                const grid = longData.input.map((_, r) => `
                    <div class="bg-white/60 border border-white rounded-2xl p-4 mb-4 shadow-sm">
                        <div class="flex justify-between mb-2 px-1">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">D√≤ng ${r+1}</span>
                            <span id="p-${r}" class="text-[10px] font-bold text-slate-300">0/40</span>
                        </div>
                        <div class="flex flex-wrap gap-1.5">
                            ${Array(40).fill('').map((_, c) => `
                                <input data-r="${r}" data-c="${c}" value="${longData.input[r][c]}" type="text" inputmode="numeric" maxlength="1"
                                class="number-box w-8 h-10 sm:w-9 sm:h-11 text-center font-digit text-lg border border-transparent rounded-lg bg-white shadow-sm text-slate-700 focus:ring-2 focus:ring-brand-500 focus:border-brand-500">
                            `).join('')}
                        </div>
                    </div>
                `).join('');

                html = `
                <div class="glass-panel rounded-3xl h-[85vh] flex flex-col shadow-2xl overflow-hidden">
                    <div class="p-4 border-b border-white/50 bg-white/30 flex justify-between items-center backdrop-blur-md z-10">
                         <span class="px-3 py-1 rounded-full bg-amber-100 text-amber-700 text-xs font-black uppercase tracking-wider">TR·∫¢ L·ªúI</span>
                        <div id="timer-txt" class="font-digit text-2xl font-bold text-slate-700">${fmtTime(timer.val)}</div>
                        <button onclick="scoreLong()" class="px-6 py-2 bg-brand-600 text-white rounded-xl font-bold text-sm shadow-lg shadow-brand-500/30 hover:bg-brand-700 transition-all">N·ªôp b√†i ‚úì</button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 md:p-6 custom-scrollbar bg-slate-50/30">${grid}</div>
                </div>`;
            }

            // 6. RESULT PHASE
            else if(activeType === 'longRes') {
                const pct = longData.score.t ? Math.round((longData.score.c/longData.score.t)*100) : 0;
                const color = pct>=80 ? 'text-green-500' : (pct>=50 ? 'text-amber-500' : 'text-red-500');
                
                const details = longData.lines.map((l, i) => {
                    const u = longData.input[i].join('');
                    let res = '';
                    for(let k=0; k<l.length; k++) {
                        if(k<u.length) res += `<span class="${u[k]===l[k]?'char-correct':'char-incorrect'}">${l[k]}</span>`;
                        else res += `<span class="char-missing">${l[k]}</span>`;
                        if((k+1)%2===0) res+=' ';
                    }
                    if(u.length > l.length) res += `<span class="char-incorrect">${u.substring(l.length)}</span>`;

                    return `
                    <div class="bg-white/50 border border-white rounded-2xl p-5 mb-4 shadow-sm">
                        <div class="font-bold text-slate-700 mb-3 text-sm border-b border-slate-100 pb-2">D√≤ng ${i+1}</div>
                        <div class="grid grid-cols-[60px_1fr] gap-y-2 font-digit text-sm">
                            <div class="text-slate-400 text-[10px] uppercase pt-1 font-bold">G·ªëc</div>
                            <div class="text-slate-500 break-all">${grp2(l)}</div>
                            <div class="text-slate-400 text-[10px] uppercase pt-1 font-bold">B·∫°n</div>
                            <div class="text-slate-800 break-all font-bold">${grp2(u)||'-'}</div>
                            <div class="text-slate-400 text-[10px] uppercase pt-1 font-bold">Sai/ƒê√∫ng</div>
                            <div class="bg-white p-2 rounded-lg border border-slate-100 shadow-inner break-all leading-relaxed">${res}</div>
                        </div>
                    </div>`;
                }).join('');

                html = `
                <div class="max-w-4xl mx-auto pb-12">
                    <div class="glass-panel rounded-3xl p-8 text-center mb-8 shadow-lg relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-${pct>=50?'green':'red'}-400 to-${pct>=50?'green':'red'}-600"></div>
                        <h2 class="text-xl font-bold text-slate-800 mb-6 uppercase tracking-widest">K·∫øt Qu·∫£ T·ªïng H·ª£p</h2>
                        <div class="flex justify-center items-end gap-2 mb-2">
                            <span class="text-6xl font-black ${color} drop-shadow-sm">${pct}%</span>
                            <span class="text-xl font-bold text-slate-400 mb-2">ch√≠nh x√°c</span>
                        </div>
                        <div class="text-slate-500 font-medium mb-8">ƒê·∫°t <strong class="text-slate-800">${longData.score.c}</strong> tr√™n t·ªïng s·ªë ${longData.score.t} ƒëi·ªÉm</div>
                        <div class="flex justify-center gap-4">
                            <button onclick="stop()" class="px-6 py-2.5 rounded-xl font-bold text-slate-500 hover:bg-slate-100 border border-transparent hover:border-slate-200 transition-all">V·ªÅ Menu</button>
                            <button onclick="startLong()" class="px-6 py-2.5 rounded-xl font-bold text-white bg-brand-600 hover:bg-brand-700 shadow-lg shadow-brand-500/30 transition-all">L√†m l·∫°i b√†i t·∫≠p</button>
                        </div>
                    </div>
                    <div class="space-y-4">${details}</div>
                </div>`;
            }

            app.innerHTML = html;
        }

        // --- EVENTS ---
        document.addEventListener('input', e => {
            // Short
            if(e.target.matches('input[data-i]')) {
                const i = parseInt(e.target.dataset.i);
                shortData.input[i] = e.target.value;
                if(e.target.value && i < shortData.digit-1) document.querySelector(`input[data-i="${i+1}"]`).focus();
                if(shortData.input.join('').length === shortData.digit) checkShort();
            }
            // Long
            if(e.target.matches('input[data-r]')) {
                const r = parseInt(e.target.dataset.r);
                const c = parseInt(e.target.dataset.c);
                longData.input[r][c] = e.target.value;
                
                // Update Progress
                const f = longData.input[r].filter(x=>x).length;
                const p = document.getElementById(`p-${r}`);
                if(p) { p.innerText = `${f}/40`; p.className = f===40 ? 'text-[10px] font-bold text-green-500' : 'text-[10px] font-bold text-slate-300'; }

                // Auto Jump
                if(e.target.value) {
                    if(c < 39) document.querySelector(`input[data-r="${r}"][data-c="${c+1}"]`)?.focus();
                    else document.querySelector(`input[data-r="${r+1}"][data-c="0"]`)?.focus();
                }
            }
        });

        function bindNav() {
            document.querySelectorAll('input[data-r]').forEach(el => {
                el.addEventListener('keydown', e => {
                    const r = parseInt(el.dataset.r), c = parseInt(el.dataset.c);
                    let n = null;
                    if(e.key==='ArrowRight') n=document.querySelector(`input[data-r="${r}"][data-c="${c+1}"]`);
                    if(e.key==='ArrowLeft') n=document.querySelector(`input[data-r="${r}"][data-c="${c-1}"]`);
                    if(e.key==='ArrowDown') n=document.querySelector(`input[data-r="${r+1}"][data-c="${c}"]`);
                    if(e.key==='ArrowUp') n=document.querySelector(`input[data-r="${r-1}"][data-c="${c}"]`);
                    if(e.key==='Backspace' && !el.value) n=document.querySelector(`input[data-r="${r}"][data-c="${c-1}"]`);
                    if(n) { if(e.key!=='Backspace') e.preventDefault(); n.focus(); if(e.key!=='Backspace') n.select(); }
                });
            });
        }

        // Init
        init();
    </script>
</body>
</html>
