<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Memory Pro Mobile</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Roboto Mono', 'monospace'],
                    },
                    colors: {
                        primary: { 600: '#2563eb', 700: '#1d4ed8' } // Royal Blue
                    }
                }
            }
        }
    </script>
    <style>
        /* N·ªÅn ch·ªëng ch√≥i, b·∫£o v·ªá m·∫Øt */
        body { background-color: #f8fafc; color: #334155; }
        
        /* Input t·ªëi ∆∞u c·∫£m ·ª©ng */
        .number-box {
            transition: all 0.15s;
            -webkit-appearance: none;
            margin: 0;
            border-radius: 8px;
        }
        .number-box:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
            outline: none;
            background-color: #fff;
            transform: scale(1.05);
            z-index: 10;
        }

        /* M√†u k·∫øt qu·∫£ */
        .char-correct { color: #15803d; font-weight: 700; }
        .char-incorrect { color: #b91c1c; text-decoration: line-through; opacity: 0.8; }
        .char-missing { background-color: #fef3c7; color: #b45309; }

        /* Hi·ªáu ·ª©ng che m·ªù */
        .blur-content { opacity: 0.15; filter: blur(5px); user-select: none; }
        
        /* L∆∞·ªõi nh·∫≠p li·ªáu th√¥ng minh tr√™n mobile */
        .grid-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(32px, 1fr));
            gap: 6px;
        }
        @media (min-width: 640px) {
            .grid-inputs { grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; }
        }
    </style>
</head>
<body class="antialiased pb-10 min-h-screen flex flex-col">

    <!-- Header -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 h-14 flex-none shadow-sm">
        <div class="container mx-auto px-4 h-full flex items-center justify-between max-w-4xl">
            <div class="flex items-center gap-2 cursor-pointer active:opacity-70" onclick="window.location.reload()">
                <div class="bg-primary-600 text-white p-1.5 rounded-lg shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </div>
                <span class="font-bold text-slate-800 text-lg tracking-tight">Memory<span class="text-primary-600">Pro</span></span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="app" class="container mx-auto px-3 py-6 max-w-4xl flex-1 flex flex-col"></main>

    <script>
        // --- STATE ---
        let activeView = 'home'; 
        
        // Short Memory State
        let sm = { data: [], input: [], count: 1, streak: 0, best: parseInt(localStorage.getItem('best_sm')||0) };
        let smTimer = null;
        let smFeedback = '';
        let smShow = false;

        // Long Memory State
        let lm = { 
            lines: [], inputs: [], mask: {}, 
            config: { mem: 5, ans: 5, cnt: 2 },
            timer: 0, timerId: null
        };

        const app = document.getElementById('app');

        // --- UTILS ---
        const fmtTime = s => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
        const grp = s => s ? s.match(/.{1,2}/g).join(' ') : ''; // Nh√≥m 2 s·ªë

        // --- RENDERER ---
        function render() {
            let html = '';

            // 1. HOME SCREEN
            if(activeView === 'home') {
                html = `
                <div class="grid gap-4 md:grid-cols-2 animate-fade-in mt-4">
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm active:scale-95 transition-transform cursor-pointer" onclick="startSM()">
                        <div class="w-14 h-14 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-3xl mb-4 shadow-inner">‚ö°</div>
                        <h2 class="text-xl font-bold text-slate-800">Ph·∫£n X·∫° Nhanh</h2>
                        <p class="text-slate-500 text-sm mt-1 mb-4">Luy·ªán tr√≠ nh·ªõ ng·∫Øn h·∫°n.</p>
                        <div class="text-xs font-bold text-slate-400 uppercase bg-slate-50 inline-block px-2 py-1 rounded">K·ª∑ l·ª•c: ${sm.best}</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm active:scale-95 transition-transform cursor-pointer" onclick="configLM()">
                        <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-3xl mb-4 shadow-inner">üß†</div>
                        <h2 class="text-xl font-bold text-slate-800">D·ªØ Li·ªáu L·ªõn</h2>
                        <p class="text-slate-500 text-sm mt-1 mb-4">Luy·ªán nh·ªõ s·ªë l∆∞·ª£ng l·ªõn.</p>
                        <div class="text-xs font-bold text-slate-400 uppercase bg-slate-50 inline-block px-2 py-1 rounded">Ch·∫ø ƒë·ªô Pro</div>
                    </div>
                </div>`;
            }

            // 2. SHORT MEMORY
            else if(activeView === 'sm_play') {
                if(smShow) {
                    // Logic ch·ªânh c·ª° ch·ªØ th√¥ng minh ƒë·ªÉ kh√¥ng b·ªã tr√†n m√†n h√¨nh
                    let textSize = 'text-7xl'; // M·∫∑c ƒë·ªãnh c·ª±c l·ªõn
                    if(sm.count > 25) textSize = 'text-2xl';
                    else if(sm.count > 15) textSize = 'text-3xl';
                    else if(sm.count > 8) textSize = 'text-5xl';

                    html = `
                    <div class="flex-1 flex flex-col items-center justify-center min-h-[60vh] px-4">
                        <div class="text-slate-400 text-xs font-bold uppercase mb-8 tracking-[0.2em]">GHI NH·ªö</div>
                        
                        <!-- V√πng hi·ªÉn th·ªã s·ªë: break-words ƒë·ªÉ t·ª± xu·ªëng d√≤ng -->
                        <div class="${textSize} font-mono font-bold text-slate-800 tracking-widest select-none drop-shadow-sm text-center w-full break-words leading-relaxed">
                            ${sm.data.join('')}
                        </div>

                        <div class="mt-12 w-48 h-1.5 bg-slate-200 rounded-full overflow-hidden flex-none">
                            <div class="h-full bg-primary-600 animate-[width_linear_forwards]" style="width:100%; animation-duration:${Math.max(1, sm.count*0.6)}s"></div>
                        </div>
                    </div>`;
                } else {
                    let fbHtml = '';
                    if(smFeedback === 'correct') fbHtml = `<div class="mt-8 p-4 bg-green-100 text-green-700 rounded-xl font-bold text-center animate-bounce">‚ú® Ch√≠nh x√°c!</div>`;
                    else if(smFeedback) fbHtml = `
                        <div class="mt-8 p-6 bg-white border border-red-100 shadow-lg rounded-2xl text-center animate-shake">
                            <div class="text-red-600 font-bold text-lg mb-1">Sai r·ªìi!</div>
                            <div class="text-slate-400 text-sm">ƒê√°p √°n: <span class="font-mono font-bold text-slate-800 text-xl break-all">${smFeedback.split(':')[1]}</span></div>
                            <button onclick="startSM()" class="mt-4 px-6 py-2 bg-slate-800 text-white rounded-lg font-bold active:bg-slate-900">Th·ª≠ l·∫°i</button>
                        </div>`;

                    html = `
                    <div class="max-w-2xl mx-auto w-full mt-4">
                        <div class="flex justify-between items-center mb-6">
                            <button onclick="goHome()" class="text-slate-400 font-bold text-sm hover:text-slate-600">‚Üê Tho√°t</button>
                            <span class="text-xs font-bold bg-white border px-3 py-1 rounded-full text-slate-500">Level ${sm.count}</span>
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-10 flex flex-col items-center">
                            <p class="text-slate-400 text-xs font-bold uppercase mb-6 tracking-wider">Nh·∫≠p d√£y s·ªë</p>
                            <div class="flex flex-wrap justify-center gap-3">
                                ${Array(sm.count).fill('').map((_, i) => `
                                    <input data-type="sm" data-idx="${i}" value="${sm.input[i]||''}" type="tel" pattern="[0-9]*" maxlength="1" 
                                    class="number-box w-12 h-16 md:w-16 md:h-20 text-3xl md:text-4xl text-center font-bold bg-slate-50 border border-slate-200 text-slate-800 placeholder-transparent caret-primary-600"
                                    ${smFeedback?'disabled':''}>
                                `).join('')}
                            </div>
                            ${fbHtml}
                        </div>
                    </div>`;
                }
            }

            // 3. LONG MEMORY CONFIG
            else if(activeView === 'lm_cfg') {
                html = `
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 max-w-md mx-auto mt-6">
                    <h2 class="text-xl font-bold text-slate-800 mb-6">C·∫•u h√¨nh b√†i t·∫≠p</h2>
                    <div class="space-y-5">
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-2">Th·ªùi gian nh·ªõ (ph√∫t)</label><input id="lm-mem" type="number" value="5" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800 focus:border-primary-600 outline-none text-lg"></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-2">Th·ªùi gian tr·∫£ l·ªùi (ph√∫t)</label><input id="lm-ans" type="number" value="5" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800 focus:border-primary-600 outline-none text-lg"></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase block mb-2">S·ªë d√≤ng (40 s·ªë/d√≤ng)</label><input id="lm-cnt" type="number" value="2" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800 focus:border-primary-600 outline-none text-lg"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-8">
                        <button onclick="goHome()" class="py-3 rounded-xl font-bold text-slate-600 bg-slate-50 hover:bg-slate-100">H·ªßy</button>
                        <button onclick="startLM()" class="py-3 rounded-xl font-bold text-white bg-primary-600 hover:bg-primary-700 shadow-md shadow-blue-200">B·∫Øt ƒë·∫ßu</button>
                    </div>
                </div>`;
            }

            // 4. LONG MEMORY - MEMORIZE
            else if(activeView === 'lm_mem') {
                const rows = lm.lines.map((line, i) => `
                    <div class="bg-white rounded-xl border border-slate-200 p-4 mb-3 shadow-sm active:scale-[0.99] transition-transform" onclick="toggleMask(${i})">
                        <div class="flex justify-between items-center mb-3">
                            <span class="bg-slate-100 text-slate-500 px-2 py-1 rounded text-[10px] font-bold uppercase">D√≤ng ${i+1}</span>
                            ${lm.mask[i] ? '<span class="text-xs font-bold text-slate-400 flex items-center gap-1">üëÅÔ∏è ƒê√£ che</span>' : ''}
                        </div>
                        <div id="row-${i}" class="font-mono text-xl md:text-2xl text-slate-800 leading-relaxed break-all tracking-wide ${lm.mask[i]?'blur-content':''} transition-all duration-200 select-none">
                            ${grp(line)}
                        </div>
                    </div>
                `).join('');

                html = `
                <div class="flex flex-col h-full">
                    <div class="sticky top-0 z-20 bg-[#f8fafc] pb-4 pt-2">
                        <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex justify-between items-center">
                            <div>
                                <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Th·ªùi gian c√≤n</div>
                                <div id="timer" class="font-mono text-2xl font-bold text-slate-800 leading-none">${fmtTime(lm.timer)}</div>
                            </div>
                            <button onclick="lmPhase2()" class="bg-primary-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-sm active:bg-primary-700">Tr·∫£ l·ªùi ngay</button>
                        </div>
                    </div>
                    <div class="flex-1 pb-10 space-y-2">${rows}</div>
                </div>`;
            }

            // 5. LONG MEMORY - ANSWER
            else if(activeView === 'lm_ans') {
                const rows = lm.inputs.map((_, r) => `
                    <div class="bg-white rounded-xl border border-slate-200 p-3 mb-3 shadow-sm">
                        <div class="flex justify-between items-center mb-2 px-1">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">D√≤ng ${r+1}</span>
                            <span id="prog-${r}" class="text-[10px] font-bold text-slate-300">0/40</span>
                        </div>
                        <div class="grid-inputs">
                            ${Array(40).fill('').map((_, c) => `
                                <input data-type="lm" data-r="${r}" data-c="${c}" value="${lm.inputs[r][c]}" type="tel" pattern="[0-9]*" maxlength="1"
                                class="number-box h-10 md:h-12 text-center font-mono text-lg md:text-xl font-bold bg-slate-50 border border-slate-200 text-slate-900 p-0">
                            `).join('')}
                        </div>
                    </div>
                `).join('');

                html = `
                <div class="flex flex-col h-full">
                    <div class="sticky top-0 z-20 bg-[#f8fafc] pb-4 pt-2">
                        <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex justify-between items-center">
                             <div>
                                <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Th·ªùi gian tr·∫£ l·ªùi</div>
                                <div id="timer" class="font-mono text-2xl font-bold text-slate-800 leading-none">${fmtTime(lm.timer)}</div>
                            </div>
                            <button onclick="lmScore()" class="bg-green-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-sm active:bg-green-700">N·ªôp b√†i ‚úì</button>
                        </div>
                    </div>
                    <div class="flex-1 pb-10">${rows}</div>
                </div>`;
            }

            // 6. RESULT
            else if(activeView === 'lm_res') {
                let totalC = 0, totalT = 0;
                const details = lm.lines.map((line, i) => {
                    const u = lm.inputs[i].join('');
                    totalT += 40;
                    let ls = 0; // line score
                    if(i < lm.lines.length - 1) { // strict
                        let d = Math.abs(line.length - u.length);
                        for(let k=0; k<Math.min(line.length, u.length); k++) if(u[k]!==line[k]) d++;
                        if(d===0) ls=40; else if(d===1) ls=20;
                    } else { // loose (last line)
                        let d = 0, len = u.trim().length;
                        for(let k=0; k<Math.min(len, line.length); k++) if(u[k]!==line[k]) d++;
                        if(d===0 && len>0) ls=len; else if(d===1 && len>0) ls=Math.ceil(len/2);
                    }
                    totalC += ls;

                    let htmlRes = '';
                    for(let k=0; k<line.length; k++) {
                        if(k < u.length) htmlRes += `<span class="${u[k]===line[k]?'char-correct':'char-incorrect'}">${line[k]}</span>`;
                        else htmlRes += `<span class="char-missing">${line[k]}</span>`;
                        if((k+1)%2===0) htmlRes += ' ';
                    }
                    if(u.length > line.length) htmlRes += `<span class="char-incorrect">${u.substring(line.length)}</span>`;

                    return `
                    <div class="bg-white p-4 rounded-xl border border-slate-200 mb-4 shadow-sm">
                        <div class="text-xs font-bold text-slate-500 mb-2 pb-2 border-b border-slate-100 flex justify-between">
                            <span>D√íNG ${i+1}</span>
                            <span class="${ls===40?'text-green-600':'text-slate-400'}">${ls}/40 ƒëi·ªÉm</span>
                        </div>
                        <div class="space-y-2 font-mono text-sm md:text-base">
                            <div><span class="text-[10px] font-bold text-slate-400 uppercase block">G·ªëc</span><div class="text-slate-500 break-all">${grp(line)}</div></div>
                            <div><span class="text-[10px] font-bold text-slate-400 uppercase block">B·∫°n</span><div class="text-slate-800 break-all font-bold">${grp(u)||'-'}</div></div>
                            <div><span class="text-[10px] font-bold text-slate-400 uppercase block">Check</span><div class="bg-slate-50 p-2 rounded border border-slate-100 break-all leading-relaxed">${htmlRes}</div></div>
                        </div>
                    </div>`;
                }).join('');

                const pct = Math.round((totalC/totalT)*100);
                const color = pct>=50 ? 'text-green-600' : 'text-red-600';

                html = `
                <div class="max-w-3xl mx-auto pb-10 mt-4">
                    <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm text-center mb-6">
                        <h2 class="text-xs font-bold text-slate-400 uppercase tracking-[0.2em] mb-2">T·ªîNG K·∫æT</h2>
                        <div class="text-6xl font-black ${color} mb-2 tracking-tight">${pct}%</div>
                        <div class="text-slate-500 font-bold text-lg">${totalC} / ${totalT} ƒëi·ªÉm</div>
                        <div class="flex justify-center gap-3 mt-8">
                            <button onclick="goHome()" class="px-6 py-3 border border-slate-200 rounded-xl font-bold text-slate-600 bg-slate-50">Menu</button>
                            <button onclick="startLM()" class="px-6 py-3 bg-primary-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200">L√†m l·∫°i</button>
                        </div>
                    </div>
                    ${details}
                </div>`;
            }

            app.innerHTML = html;
            // Auto-focus logic for Long Memory Answer phase
            if(activeView === 'lm_ans') setTimeout(bindInputs, 100);
        }

        // --- LOGIC ---
        function goHome() { stopTimer(); activeView = 'home'; render(); }
        
        function startSM() { activeView = 'sm_play'; sm.count=1; sm.streak=0; genSM(); }
        function genSM() {
            clearTimeout(smTimer);
            smFeedback=''; smShow=true;
            sm.data = Array.from({length:sm.count}, () => Math.floor(Math.random()*10));
            sm.input = Array(sm.count).fill('');
            render();
            
            const wait = Math.max(1000, sm.count*600);
            smTimer = setTimeout(() => {
                smShow=false; render();
                
                // FIX MOBILE KEYBOARD AUTO-FOCUS
                setTimeout(() => {
                    const el = document.querySelector('input[data-idx="0"]');
                    if(el) { 
                        el.focus(); 
                        el.click(); // Trigger ·∫£o ƒë·ªÉ b·∫≠t b√†n ph√≠m iOS
                    }
                }, 100); 
            }, wait);
        }
        function checkSM() {
            const u = sm.input.join('');
            const r = sm.data.join('');
            if(u===r) {
                smFeedback='correct'; sm.streak++;
                if(sm.streak>sm.best) { sm.best=sm.streak; localStorage.setItem('best_sm', sm.best); }
                render();
                setTimeout(() => { sm.count++; genSM(); }, 1000);
            } else {
                smFeedback=`:${r}`; sm.streak=0; render();
            }
        }

        function configLM() { activeView='lm_cfg'; render(); }
        function startLM() {
            lm.config.mem = parseInt(document.getElementById('lm-mem').value)||5;
            lm.config.ans = parseInt(document.getElementById('lm-ans').value)||5;
            lm.config.cnt = parseInt(document.getElementById('lm-cnt').value)||2;
            lm.lines = Array(lm.config.cnt).fill().map(() => Array.from({length:40}, ()=>Math.floor(Math.random()*10)).join(''));
            lm.mask = {};
            activeView = 'lm_mem';
            lm.timer = lm.config.mem * 60;
            startTimer(() => { lmPhase2(); });
            render();
        }
        function toggleMask(i) {
            lm.mask[i] = !lm.mask[i];
            const el = document.getElementById(`row-${i}`);
            if(el) {
                el.classList.toggle('blur-content');
                render(); 
            }
        }
        function lmPhase2() {
            stopTimer();
            activeView = 'lm_ans';
            lm.inputs = Array(lm.config.cnt).fill().map(()=>Array(40).fill(''));
            lm.timer = lm.config.ans * 60;
            startTimer(() => { lmScore(); });
            render();
        }
        function lmScore() { stopTimer(); activeView = 'lm_res'; render(); }

        function startTimer(cb) {
            if(lm.timerId) clearInterval(lm.timerId);
            lm.timerId = setInterval(() => {
                lm.timer--;
                const el = document.getElementById('timer');
                if(el) {
                    el.innerText = fmtTime(lm.timer);
                    if(lm.timer < 60) el.classList.add('text-red-600');
                }
                if(lm.timer <= 0) { stopTimer(); cb(); }
            }, 1000);
        }
        function stopTimer() { if(lm.timerId) clearInterval(lm.timerId); }

        // --- EVENTS ---
        document.addEventListener('input', e => {
            const t = e.target;
            // Short Memory Input
            if(t.dataset.type === 'sm') {
                const i = parseInt(t.dataset.idx);
                sm.input[i] = t.value;
                if(t.value && i < sm.count-1) document.querySelector(`input[data-idx="${i+1}"]`).focus();
                if(sm.input.join('').length === sm.count) checkSM();
            }
            // Long Memory Input
            if(t.dataset.type === 'lm') {
                const r = parseInt(t.dataset.r), c = parseInt(t.dataset.c);
                lm.inputs[r][c] = t.value;
                // update prog label
                const f = lm.inputs[r].filter(x=>x).length;
                const p = document.getElementById(`prog-${r}`);
                if(p) { p.innerText = `${f}/40`; p.className = f===40?'text-[10px] font-bold text-green-600':'text-[10px] font-bold text-slate-300'; }
                // auto jump
                if(t.value) {
                    if(c < 39) document.querySelector(`input[data-r="${r}"][data-c="${c+1}"]`)?.focus();
                    else document.querySelector(`input[data-r="${r+1}"][data-c="0"]`)?.focus();
                }
            }
        });

        function bindInputs() {}

        // Init
        render();

    </script>
</body>
</html>
