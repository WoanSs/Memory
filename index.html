<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Memory Trainer Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts: Inter (UI) & Roboto Mono (Numbers) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Roboto Mono', 'monospace'],
                    },
                    colors: {
                        primary: { 600: '#2563eb', 700: '#1d4ed8' }, // Royal Blue (D·ªÖ ch·ªãu)
                        dark: { 800: '#1e293b', 900: '#0f172a' }     // Slate Dark
                    }
                }
            }
        }
    </script>
    <style>
        /* N·ªÅn d·ªãu m·∫Øt */
        body { background-color: #f1f5f9; color: #1e293b; }
        
        /* Input styles t·ªëi ∆∞u c·∫£m ·ª©ng */
        .number-box {
            transition: border-color 0.15s, box-shadow 0.15s;
            -webkit-appearance: none; /* Fix iOS styles */
            margin: 2px;
        }
        .number-box:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
            outline: none;
            background-color: #fff;
        }

        /* M√†u k·∫øt qu·∫£ t∆∞∆°ng ph·∫£n cao */
        .char-correct { color: #15803d; font-weight: 700; } /* Green-700 */
        .char-incorrect { color: #b91c1c; text-decoration: line-through; opacity: 0.8; } /* Red-700 */
        .char-missing { background-color: #fef3c7; color: #b45309; } /* Amber */

        /* Masking */
        .blur-content { opacity: 0.2; filter: blur(4px); user-select: none; }
        
        /* Mobile Grid Fixes */
        .grid-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(28px, 1fr));
            gap: 4px;
        }
        @media (min-width: 640px) {
            .grid-inputs { grid-template-columns: repeat(auto-fill, minmax(36px, 1fr)); gap: 6px; }
        }
    </style>
</head>
<body class="antialiased pb-10">

    <!-- Header ƒë∆°n gi·∫£n -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="container mx-auto px-4 h-14 flex items-center justify-between max-w-4xl">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.reload()">
                <div class="bg-primary-600 text-white p-1.5 rounded-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </div>
                <span class="font-bold text-slate-800 text-lg tracking-tight">Memory<span class="text-primary-600">Pro</span></span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="app" class="container mx-auto px-3 py-6 max-w-4xl"></main>

    <script>
        // --- STATE ---
        let activeView = 'home'; 
        
        // Short Mem State
        let sm = { data: [], input: [], count: 1, streak: 0, best: parseInt(localStorage.getItem('best_sm')||0) };
        let smTimer = null;
        let smFeedback = '';
        let smShow = false;

        // Long Mem State
        let lm = { 
            lines: [], 
            inputs: [], 
            mask: {}, 
            config: { mem: 5, ans: 5, cnt: 2 },
            timer: 0,
            timerId: null
        };

        const app = document.getElementById('app');

        // --- UTILS ---
        const fmtTime = s => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
        // Group numbers by 2, add space
        const grp = s => s ? s.match(/.{1,2}/g).join(' ') : '';

        // --- VIEWS RENDERER ---
        function render() {
            let html = '';

            // 1. HOME SCREEN
            if(activeView === 'home') {
                html = `
                <div class="grid gap-4 md:grid-cols-2">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:border-primary-600 transition-colors cursor-pointer" onclick="startSM()">
                        <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center text-2xl mb-4">‚ö°</div>
                        <h2 class="text-xl font-bold text-slate-800">Ph·∫£n X·∫° Nhanh</h2>
                        <p class="text-slate-500 text-sm mt-2 mb-4">Nh·ªõ s·ªë ng·∫´u nhi√™n t·ª©c th√¨.</p>
                        <div class="text-xs font-bold text-slate-400 uppercase">K·ª∑ l·ª•c: ${sm.best}</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:border-primary-600 transition-colors cursor-pointer" onclick="configLM()">
                        <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-lg flex items-center justify-center text-2xl mb-4">üß†</div>
                        <h2 class="text-xl font-bold text-slate-800">D·ªØ Li·ªáu L·ªõn</h2>
                        <p class="text-slate-500 text-sm mt-2 mb-4">Nh·ªõ 40 s·ªë/d√≤ng. Ch·∫ø ƒë·ªô chuy√™n nghi·ªáp.</p>
                        <div class="text-xs font-bold text-slate-400 uppercase">S·∫µn s√†ng</div>
                    </div>
                </div>`;
            }

            // 2. SHORT MEMORY
            else if(activeView === 'sm_play') {
                if(smShow) {
                    html = `
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 min-h-[50vh] flex flex-col items-center justify-center p-4 text-center">
                        <div class="text-slate-400 text-xs font-bold uppercase mb-8 tracking-widest">GHI NH·ªö</div>
                        <div class="text-6xl md:text-8xl font-mono font-bold text-slate-800 tracking-widest break-all">${sm.data.join('')}</div>
                        <div class="mt-10 w-full max-w-xs h-1 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-primary-600 transition-all duration-500 w-0 animate-[width_linear_forwards]" style="animation-duration: ${Math.max(1, sm.count*0.6)}s; width: 100%"></div>
                        </div>
                    </div>`;
                } else {
                    let feedbackHtml = '';
                    if(smFeedback === 'correct') {
                        feedbackHtml = `<div class="mt-6 p-3 bg-green-50 text-green-700 rounded-lg font-bold text-center">Ch√≠nh x√°c! Ti·∫øp t·ª•c...</div>`;
                    } else if(smFeedback) {
                        feedbackHtml = `
                        <div class="mt-6 p-4 bg-red-50 text-red-700 rounded-lg text-center">
                            <div class="font-bold">Sai r·ªìi!</div>
                            <div class="text-sm mt-1 text-slate-500">ƒê√°p √°n: <span class="font-mono font-bold text-slate-800">${smFeedback.split(':')[1]}</span></div>
                            <button onclick="startSM()" class="mt-3 px-4 py-2 bg-slate-800 text-white text-sm rounded shadow">Th·ª≠ l·∫°i</button>
                        </div>`;
                    }

                    html = `
                    <div class="max-w-2xl mx-auto">
                        <div class="flex justify-between items-center mb-4">
                            <button onclick="goHome()" class="text-slate-500 font-bold text-sm">‚Üê Tho√°t</button>
                            <span class="text-xs font-bold bg-slate-100 px-2 py-1 rounded text-slate-600">Level: ${sm.count}</span>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 md:p-10">
                            <p class="text-center text-slate-500 text-sm mb-6">Nh·∫≠p l·∫°i d√£y s·ªë</p>
                            <div class="flex flex-wrap justify-center gap-2 md:gap-4">
                                ${Array(sm.count).fill('').map((_, i) => `
                                    <input data-type="sm" data-idx="${i}" value="${sm.input[i]||''}" type="tel" maxlength="1" 
                                    class="number-box w-10 h-14 md:w-14 md:h-16 text-2xl md:text-3xl text-center font-bold rounded-lg border border-slate-300 bg-slate-50 text-slate-800 placeholder-transparent focus:bg-white"
                                    ${smFeedback?'disabled':''}>
                                `).join('')}
                            </div>
                            ${feedbackHtml}
                        </div>
                    </div>`;
                }
            }

            // 3. LONG MEMORY CONFIG
            else if(activeView === 'lm_cfg') {
                html = `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 max-w-md mx-auto">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">C·∫•u h√¨nh b√†i t·∫≠p</h2>
                    <div class="space-y-4">
                        <div><label class="text-sm font-semibold text-slate-600 block mb-1">Th·ªùi gian nh·ªõ (ph√∫t)</label><input id="lm-mem" type="number" value="5" class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg font-bold text-slate-800 focus:border-primary-600 outline-none"></div>
                        <div><label class="text-sm font-semibold text-slate-600 block mb-1">Th·ªùi gian tr·∫£ l·ªùi (ph√∫t)</label><input id="lm-ans" type="number" value="5" class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg font-bold text-slate-800 focus:border-primary-600 outline-none"></div>
                        <div><label class="text-sm font-semibold text-slate-600 block mb-1">S·ªë d√≤ng (40 s·ªë/d√≤ng)</label><input id="lm-cnt" type="number" value="2" class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg font-bold text-slate-800 focus:border-primary-600 outline-none"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-6">
                        <button onclick="goHome()" class="py-2.5 rounded-lg font-bold text-slate-600 border border-slate-200 hover:bg-slate-50">H·ªßy</button>
                        <button onclick="startLM()" class="py-2.5 rounded-lg font-bold text-white bg-primary-600 hover:bg-primary-700 shadow-sm">B·∫Øt ƒë·∫ßu</button>
                    </div>
                </div>`;
            }

            // 4. LONG MEMORY - MEMORIZE
            else if(activeView === 'lm_mem') {
                const rows = lm.lines.map((line, i) => `
                    <div class="bg-white rounded-xl border border-slate-200 p-3 md:p-4 mb-3 shadow-sm relative cursor-pointer hover:border-primary-400" onclick="toggleMask(${i})">
                        <div class="flex justify-between items-center mb-2">
                            <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-xs font-bold">D√≤ng ${i+1}</span>
                            <span class="text-slate-300 text-xs uppercase font-bold tracking-wider">${lm.mask[i] ? 'ƒê√£ che' : 'Ch·∫°m ƒë·ªÉ che'}</span>
                        </div>
                        <div id="row-${i}" class="font-mono text-lg md:text-xl text-slate-800 leading-relaxed break-all tracking-wide ${lm.mask[i]?'blur-content':''} transition-all">
                            ${grp(line)}
                        </div>
                    </div>
                `).join('');

                html = `
                <div class="flex flex-col h-[calc(100vh-80px)]">
                    <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center mb-3 sticky top-0 z-10">
                        <div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase">Th·ªùi gian c√≤n</div>
                            <div id="timer" class="font-mono text-2xl font-bold text-slate-800 leading-none">${fmtTime(lm.timer)}</div>
                        </div>
                        <button onclick="lmPhase2()" class="bg-primary-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-sm">Tr·∫£ l·ªùi ‚ûú</button>
                    </div>
                    <div class="flex-1 overflow-y-auto pb-20 space-y-2">
                        ${rows}
                    </div>
                </div>`;
            }

            // 5. LONG MEMORY - ANSWER
            else if(activeView === 'lm_ans') {
                const rows = lm.inputs.map((_, r) => `
                    <div class="bg-white rounded-xl border border-slate-200 p-3 mb-3 shadow-sm">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-slate-500">D√íNG ${r+1}</span>
                            <span id="prog-${r}" class="text-xs font-bold text-slate-300">0/40</span>
                        </div>
                        <div class="grid-inputs">
                            ${Array(40).fill('').map((_, c) => `
                                <input data-type="lm" data-r="${r}" data-c="${c}" value="${lm.inputs[r][c]}" type="tel" maxlength="1"
                                class="number-box h-10 md:h-12 text-center font-mono text-lg md:text-xl font-bold bg-slate-50 border border-slate-200 rounded text-slate-900 focus:bg-white p-0">
                            `).join('')}
                        </div>
                    </div>
                `).join('');

                html = `
                <div class="flex flex-col h-[calc(100vh-80px)]">
                    <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center mb-3 sticky top-0 z-10">
                        <div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase">Th·ªùi gian tr·∫£ l·ªùi</div>
                            <div id="timer" class="font-mono text-2xl font-bold text-slate-800 leading-none">${fmtTime(lm.timer)}</div>
                        </div>
                        <button onclick="lmScore()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-sm">N·ªôp b√†i ‚úì</button>
                    </div>
                    <div class="flex-1 overflow-y-auto pb-20">
                        ${rows}
                    </div>
                </div>`;
            }

            // 6. LONG MEMORY - RESULT
            else if(activeView === 'lm_res') {
                let totalC = 0, totalT = 0;
                const details = lm.lines.map((line, i) => {
                    const u = lm.inputs[i].join('');
                    totalT += 40;
                    
                    // Simple scoring calc for display
                    let lineScore = 0;
                    if(i < lm.lines.length - 1) { // strict
                        let diff = Math.abs(line.length - u.length);
                        for(let k=0; k<Math.min(line.length, u.length); k++) if(u[k]!==line[k]) diff++;
                        if(diff===0) lineScore=40; else if(diff===1) lineScore=20;
                    } else { // last line
                        let diff = 0, len = u.trim().length;
                        for(let k=0; k<Math.min(len, line.length); k++) if(u[k]!==line[k]) diff++;
                        if(diff===0 && len>0) lineScore=len; else if(diff===1 && len>0) lineScore=Math.ceil(len/2);
                    }
                    totalC += lineScore;

                    // Generate diff view
                    let htmlRes = '';
                    for(let k=0; k<line.length; k++) {
                        if(k < u.length) htmlRes += `<span class="${u[k]===line[k]?'char-correct':'char-incorrect'}">${line[k]}</span>`;
                        else htmlRes += `<span class="char-missing">${line[k]}</span>`;
                        if((k+1)%2===0) htmlRes += ' '; // space every 2 chars
                    }
                    if(u.length > line.length) htmlRes += `<span class="char-incorrect">${u.substring(line.length)}</span>`;

                    return `
                    <div class="bg-white p-4 rounded-xl border border-slate-200 mb-4 shadow-sm">
                        <div class="text-xs font-bold text-slate-500 mb-2 border-b pb-1">D√íNG ${i+1} (${lineScore}/40)</div>
                        <div class="grid gap-2 text-sm md:text-base">
                            <div>
                                <div class="text-[10px] font-bold text-slate-400 uppercase">ƒê√°p √°n</div>
                                <div class="font-mono text-slate-500 break-all">${grp(line)}</div>
                            </div>
                            <div>
                                <div class="text-[10px] font-bold text-slate-400 uppercase">B·∫°n nh·∫≠p</div>
                                <div class="font-mono text-slate-800 break-all font-bold">${grp(u)||'-'}</div>
                            </div>
                            <div>
                                <div class="text-[10px] font-bold text-slate-400 uppercase">So s√°nh</div>
                                <div class="font-mono bg-slate-50 p-2 rounded border border-slate-100 break-all leading-relaxed">${htmlRes}</div>
                            </div>
                        </div>
                    </div>`;
                }).join('');

                const pct = Math.round((totalC/totalT)*100);
                const color = pct>=50 ? 'text-green-600' : 'text-red-600';

                html = `
                <div class="max-w-3xl mx-auto pb-10">
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm text-center mb-6">
                        <h2 class="text-lg font-bold text-slate-800 uppercase tracking-widest mb-2">K·∫øt Qu·∫£</h2>
                        <div class="text-5xl font-black ${color} mb-1">${pct}%</div>
                        <div class="text-slate-500 font-bold">${totalC}/${totalT} ƒëi·ªÉm</div>
                        <div class="flex justify-center gap-3 mt-6">
                            <button onclick="goHome()" class="px-5 py-2 border border-slate-200 rounded-lg font-bold text-slate-600">Menu</button>
                            <button onclick="startLM()" class="px-5 py-2 bg-primary-600 text-white rounded-lg font-bold shadow">L√†m l·∫°i</button>
                        </div>
                    </div>
                    ${details}
                </div>`;
            }

            app.innerHTML = html;
            if(activeView === 'lm_ans') setTimeout(bindInputs, 100);
        }

        // --- LOGIC FUNCTIONS ---
        function goHome() { stopTimer(); activeView = 'home'; render(); }
        
        // Short Memory
        function startSM() { 
            activeView = 'sm_play'; sm.count=1; sm.streak=0; genSM(); 
        }
        function genSM() {
            clearTimeout(smTimer);
            smFeedback=''; smShow=true;
            sm.data = Array.from({length:sm.count}, () => Math.floor(Math.random()*10));
            sm.input = Array(sm.count).fill('');
            render();
            
            const wait = Math.max(1000, sm.count*600);
            smTimer = setTimeout(() => {
                smShow=false; render();
                setTimeout(() => document.querySelector('input')?.focus(), 50);
            }, wait);
        }
        function checkSM() {
            const u = sm.input.join('');
            const r = sm.data.join('');
            if(u===r) {
                smFeedback='correct'; sm.streak++;
                if(sm.streak>sm.best) { sm.best=sm.streak; localStorage.setItem('best_sm', sm.best); }
                render();
                setTimeout(() => { sm.count++; genSM(); }, 1000);
            } else {
                smFeedback=`inc:${r}`; sm.streak=0; render();
            }
        }

        // Long Memory
        function configLM() { activeView='lm_cfg'; render(); }
        function startLM() {
            lm.config.mem = parseInt(document.getElementById('lm-mem').value);
            lm.config.ans = parseInt(document.getElementById('lm-ans').value);
            lm.config.cnt = parseInt(document.getElementById('lm-cnt').value);
            lm.lines = Array(lm.config.cnt).fill().map(() => Array.from({length:40}, ()=>Math.floor(Math.random()*10)).join(''));
            lm.mask = {};
            activeView = 'lm_mem';
            lm.timer = lm.config.mem * 60;
            startTimer(() => { lmPhase2(); });
            render();
        }
        function toggleMask(i) {
            lm.mask[i] = !lm.mask[i];
            const el = document.getElementById(`row-${i}`);
            if(el) el.classList.toggle('blur-content');
        }
        function lmPhase2() {
            stopTimer();
            activeView = 'lm_ans';
            lm.inputs = Array(lm.config.cnt).fill().map(()=>Array(40).fill(''));
            lm.timer = lm.config.ans * 60;
            startTimer(() => { lmScore(); });
            render();
        }
        function lmScore() {
            stopTimer();
            activeView = 'lm_res';
            render();
        }

        // Common
        function startTimer(cb) {
            if(lm.timerId) clearInterval(lm.timerId);
            lm.timerId = setInterval(() => {
                lm.timer--;
                const el = document.getElementById('timer');
                if(el) {
                    el.innerText = fmtTime(lm.timer);
                    if(lm.timer < 60) el.classList.add('text-red-600');
                }
                if(lm.timer <= 0) { stopTimer(); cb(); }
            }, 1000);
        }
        function stopTimer() { if(lm.timerId) clearInterval(lm.timerId); }

        // --- EVENTS ---
        document.addEventListener('input', e => {
            const t = e.target;
            if(t.dataset.type === 'sm') {
                const i = parseInt(t.dataset.idx);
                sm.input[i] = t.value;
                if(t.value && i < sm.count-1) document.querySelector(`input[data-idx="${i+1}"]`).focus();
                if(sm.input.join('').length === sm.count) checkSM();
            }
            if(t.dataset.type === 'lm') {
                const r = parseInt(t.dataset.r), c = parseInt(t.dataset.c);
                lm.inputs[r][c] = t.value;
                // update prog
                const f = lm.inputs[r].filter(x=>x).length;
                const p = document.getElementById(`prog-${r}`);
                if(p) { p.innerText = `${f}/40`; p.className = f===40?'text-xs font-bold text-green-600':'text-xs font-bold text-slate-300'; }
                // jump
                if(t.value) {
                    if(c < 39) document.querySelector(`input[data-r="${r}"][data-c="${c+1}"]`)?.focus();
                    else document.querySelector(`input[data-r="${r+1}"][data-c="0"]`)?.focus();
                }
            }
        });

        function bindInputs() {
            // Add arrow navigation if needed, mainly handled by browser default + auto jump above
        }

        // Init
        render();

    </script>
</body>
</html>
