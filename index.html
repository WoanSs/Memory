<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Memory Pro - Luy·ªán Si√™u Tr√≠ Nh·ªõ</title>
    
    <!-- Favicon: Logo b·ªô n√£o -->
    <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%232563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>'>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'], 
                        mono: ['Roboto Mono', 'monospace'] 
                    },
                    colors: { 
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 600: '#2563eb', 700: '#1d4ed8' },
                        slate: { 850: '#1e293b' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'progress': 'progress linear forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-in': 'bounceIn 0.8s cubic-bezier(0.215, 0.61, 0.355, 1) both'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } },
                        progress: { 'from': { width: '100%' }, 'to': { width: '0%' } },
                        bounceIn: { '0%': { opacity: '0', transform: 'scale3d(0.3, 0.3, 0.3)' }, '20%': { transform: 'scale3d(1.1, 1.1, 1.1)' }, '40%': { transform: 'scale3d(0.9, 0.9, 0.9)' }, '60%': { opacity: '1', transform: 'scale3d(1.03, 1.03, 1.03)' }, '80%': { transform: 'scale3d(0.97, 0.97, 0.97)' }, '100%': { opacity: '1', transform: 'scale3d(1, 1, 1)' } }
                    },
                    gridTemplateColumns: {
                        '20': 'repeat(20, minmax(0, 1fr))',
                        '40': 'repeat(40, minmax(0, 1fr))',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #334155; -webkit-tap-highlight-color: transparent; }
        .number-box { transition: all 0.15s ease; border-radius: 6px; }
        .number-box:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); outline: none; background-color: #fff; transform: scale(1.05); z-index: 10; }
        
        .number-box.rev:focus { border-color: #ea580c; box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.15); }

        .char-correct { color: #15803d; font-weight: 700; background-color: #f0fdf4; padding: 0 1px; }
        .char-incorrect { color: #b91c1c; text-decoration: line-through; background-color: #fef2f2; padding: 0 1px; }
        .char-missing { background-color: #fef3c7; color: #b45309; padding: 0 1px; }
        .blur-content { filter: blur(8px); opacity: 0.2; user-select: none; pointer-events: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .circle-progress { transition: stroke-dashoffset 1s linear; }
        .custom-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        
        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #ffffff;
            z-index: 9999;
            display: flex;
            flex-col: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }
        #splash-screen.hidden-splash {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col font-sans">

    <!-- SPLASH SCREEN -->
    <div id="splash-screen">
        <div class="animate-bounce-in flex flex-col items-center">
            <div class="w-24 h-24 bg-primary-600 text-white rounded-3xl shadow-xl flex items-center justify-center mb-6 relative overflow-hidden">
                <div class="absolute inset-0 bg-white opacity-10 rotate-45 transform scale-150 origin-top-left"></div>
                <svg xmlns="http://www.w3.org/2000/svg" class="w-14 h-14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                </svg>
            </div>
            <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">Memory<span class="text-primary-600">Pro</span></h1>
            <p class="text-slate-400 text-sm font-medium mt-2 uppercase tracking-widest">Luy·ªán si√™u tr√≠ nh·ªõ</p>
        </div>
    </div>

    <!-- NAVBAR -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 h-16 flex-none shadow-sm">
        <div class="container mx-auto px-4 h-full flex items-center justify-between max-w-5xl">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="goHome()">
                <!-- New Logo in Navbar -->
                <div class="bg-primary-600 text-white p-2 rounded-xl shadow-md group-active:scale-90 transition-transform relative overflow-hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 relative z-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                </div>
                <span class="font-extrabold text-slate-800 text-xl tracking-tight">Memory<span class="text-primary-600">Pro</span></span>
            </div>
            <div id="nav-info" class="hidden md:block text-sm font-medium text-slate-400 uppercase tracking-widest">
                Mental Training Tool
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main id="app" class="container mx-auto px-4 py-6 max-w-5xl flex-1 flex flex-col"></main>

    <script>
        // --- SPLASH SCREEN LOGIC ---
        window.addEventListener('load', () => {
            const splash = document.getElementById('splash-screen');
            setTimeout(() => {
                splash.classList.add('hidden-splash');
            }, 1500); // Logo hi·ªán trong 1.5 gi√¢y
        });

        // --- STATE MANAGEMENT ---
        let activeView = 'home'; 
        
        // Short Memory (SM) State
        let sm = { 
            data: [], 
            inputFwd: [], 
            inputRev: [], 
            count: 2, 
            streak: 0, 
            best: parseInt(localStorage.getItem('mp_best_sm') || 0) 
        };
        let smTimer = null;
        let smFeedback = { fwd: null, rev: null, status: '' }; 
        let smShow = false;
        let smCountdown = 3; 
        let smCountdownTimer = null;

        // Long Memory (LM) State
        let lm = { 
            lines: [], 
            inputs: [], 
            mask: {}, 
            config: { mem: 5, ans: 5, cnt: 2 }, 
            timer: 0, 
            timerId: null,
            countdown: 3,
            countdownTimer: null
        };

        const app = document.getElementById('app');
        const fmtTime = s => {
            const m = Math.floor(s / 60);
            const sec = s % 60;
            return `${m}:${sec.toString().padStart(2, '0')}`;
        };

        // --- CORE FUNCTIONS ---

        function render() {
            let html = '';

            if (activeView === 'home') {
                html = `
                <div class="max-w-4xl mx-auto w-full animate-slide-up">
                    <div class="mb-8 text-center">
                        <h1 class="text-3xl font-extrabold text-slate-900 mb-2">Ch√†o m·ª´ng tr·ªü l·∫°i!</h1>
                        <p class="text-slate-500">Ch·ªçn ch·∫ø ƒë·ªô luy·ªán t·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu n√¢ng cao tr√≠ nh·ªõ c·ªßa b·∫°n.</p>
                    </div>

                    <div class="grid gap-6 md:grid-cols-2">
                        <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm hover:shadow-xl hover:border-primary-100 transition-all cursor-pointer group" onclick="startSM()">
                            <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-4xl mb-6 group-hover:scale-110 transition-transform shadow-inner">‚ö°</div>
                            <h2 class="text-2xl font-bold text-slate-800 mb-2">Ph·∫£n X·∫° Nhanh</h2>
                            <p class="text-slate-500 mb-6 leading-relaxed">Ghi nh·ªõ v√† nh·∫≠p l·∫°i c·∫£ <span class="font-bold text-blue-600">Xu√¥i</span> l·∫´n <span class="font-bold text-orange-600">Ng∆∞·ª£c</span>. Th·ª≠ th√°ch tr√≠ nh·ªõ ng·∫Øn h·∫°n t·ªëi ƒëa.</p>
                            <div class="flex items-center justify-between">
                                <span class="text-xs font-bold text-primary-600 uppercase bg-primary-50 px-3 py-1.5 rounded-full">K·ª∑ l·ª•c: ${sm.best} levels</span>
                                <span class="text-slate-300 group-hover:text-primary-600 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                                </span>
                            </div>
                        </div>
                        <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm hover:shadow-xl hover:border-indigo-100 transition-all cursor-pointer group" onclick="configLM()">
                            <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-4xl mb-6 group-hover:scale-110 transition-transform shadow-inner">üß†</div>
                            <h2 class="text-2xl font-bold text-slate-800 mb-2">D·ªØ Li·ªáu L·ªõn</h2>
                            <p class="text-slate-500 mb-6 leading-relaxed">Luy·ªán t·∫≠p tr√≠ nh·ªõ d√†i h·∫°n v·ªõi b·∫£ng s·ªë ng·∫´u nhi√™n. T√πy ch·ªânh th·ªùi gian v√† s·ªë l∆∞·ª£ng d√≤ng.</p>
                            <div class="flex items-center justify-between">
                                <span class="text-xs font-bold text-indigo-600 uppercase bg-indigo-50 px-3 py-1.5 rounded-full">Ch·∫ø ƒë·ªô chuy√™n nghi·ªáp</span>
                                <span class="text-slate-300 group-hover:text-indigo-600 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            else if (activeView === 'sm_countdown' || activeView === 'lm_countdown') {
                const count = activeView === 'sm_countdown' ? smCountdown : lm.countdown;
                const radius = 70;
                const circ = 2 * Math.PI * radius;
                const offset = circ * (1 - count / 3);

                html = `
                <div class="flex-1 flex flex-col items-center justify-center min-h-[60vh] animate-fade-in">
                    <div class="text-slate-400 text-xs font-bold uppercase mb-10 tracking-[0.3em]">Chu·∫©n b·ªã b·∫Øt ƒë·∫ßu</div>
                    <div class="relative w-40 h-40 mb-10">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="80" cy="80" r="${radius}" stroke="#e2e8f0" stroke-width="6" fill="none"/>
                            <circle cx="80" cy="80" r="${radius}" stroke="#2563eb" stroke-width="6" fill="none" 
                                    stroke-linecap="round" stroke-dasharray="${circ}" stroke-dashoffset="${offset}"
                                    class="circle-progress shadow-lg"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-6xl font-black text-slate-800 tabular-nums">${count}</span>
                        </div>
                    </div>
                    <button onclick="${activeView === 'sm_countdown' ? 'skipSMCountdown()' : 'skipLMCountdown()'}" class="text-slate-400 text-xs font-bold uppercase hover:text-primary-600 transition-colors">B·ªè qua >></button>
                </div>`;
            }

            else if (activeView === 'sm_play') {
                if (smShow) {
                    let textSize = sm.count > 15 ? 'text-2xl' : sm.count > 10 ? 'text-4xl' : 'text-6xl';
                    const rows = [];
                    for(let i=0; i<sm.data.length; i+=10) rows.push(sm.data.slice(i, i+10).join(''));
                    const duration = Math.max(1.2, sm.count * 0.5);

                    html = `
                    <div class="flex-1 flex flex-col items-center justify-center min-h-[60vh] animate-fade-in">
                        <div class="text-slate-400 text-xs font-bold uppercase mb-4 tracking-[0.2em]">Ghi nh·ªõ (${sm.count} s·ªë)</div>
                        <div class="${textSize} font-mono font-black text-slate-800 tracking-[0.2em] text-center w-full leading-relaxed drop-shadow-sm px-4">
                            ${rows.map(r => `<div class="mb-2">${r}</div>`).join('')}
                        </div>
                        <div class="mt-16 w-64 h-2 bg-slate-100 rounded-full overflow-hidden shadow-inner">
                            <div class="h-full bg-primary-600 animate-progress" style="animation-duration:${duration}s"></div>
                        </div>
                    </div>`;
                } else {
                    let fbHtml = '';
                    const isResult = smFeedback.status !== '';

                    if (smFeedback.status === 'correct') {
                        fbHtml = `<div class="mt-8 p-4 bg-green-50 text-green-700 rounded-2xl font-bold text-center border border-green-100 animate-bounce shadow-sm w-full max-w-lg">
                            <div class="text-lg">‚ú® Xu·∫•t s·∫Øc!</div>
                            <div class="text-xs font-semibold mt-1">ƒê√£ nh·ªõ ƒë√∫ng c·∫£ 2 chi·ªÅu</div>
                            <div class="text-xs font-bold mt-2 bg-white/50 inline-block px-2 py-1 rounded">+2 s·ªë ti·∫øp theo</div>
                        </div>`;
                    } else if (smFeedback.status === 'wrong') {
                        const correctFwd = sm.data.join('');
                        const correctRev = sm.data.slice().reverse().join('');
                        
                        fbHtml = `
                        <div class="mt-8 p-6 bg-white border border-red-100 shadow-xl rounded-3xl text-center animate-shake w-full max-w-lg">
                            <div class="text-red-600 font-extrabold text-xl mb-1">Ch∆∞a ch√≠nh x√°c!</div>
                            <div class="text-slate-400 text-xs mb-4 font-medium">B·∫°n d·ª´ng l·∫°i ·ªü level <span class="text-slate-800 font-bold">${sm.count}</span></div>
                            
                            <div class="grid grid-cols-2 gap-4 text-left">
                                <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 ${smFeedback.fwd ? 'opacity-50' : 'ring-2 ring-red-100'}">
                                    <div class="text-[9px] font-bold text-blue-500 uppercase mb-1">ƒê√°p √°n Xu√¥i</div>
                                    <div class="font-mono font-bold text-slate-800 text-sm break-all tracking-widest">${correctFwd}</div>
                                </div>
                                <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 ${smFeedback.rev ? 'opacity-50' : 'ring-2 ring-red-100'}">
                                    <div class="text-[9px] font-bold text-orange-500 uppercase mb-1">ƒê√°p √°n Ng∆∞·ª£c</div>
                                    <div class="font-mono font-bold text-slate-800 text-sm break-all tracking-widest">${correctRev}</div>
                                </div>
                            </div>
                            
                            <button onclick="startSM()" class="w-full py-3 mt-4 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 active:scale-95 transition-all text-sm uppercase tracking-wider">Th·ª≠ l·∫°i ngay</button>
                        </div>`;
                    }

                    // Forward Inputs
                    const inputsFwd = sm.data.map((_, i) => `
                        <input data-type="sm-fwd" data-idx="${i}" value="${sm.inputFwd[i] || ''}" type="tel" pattern="[0-9]*" maxlength="1" 
                        ${i === 0 ? 'autofocus' : ''} 
                        class="number-box w-full aspect-[3/4] text-xl md:text-2xl text-center font-bold bg-white border-2 border-slate-100 text-blue-600 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/20"
                        ${isResult ? 'disabled' : ''}>
                    `).join('');

                    // Reverse Inputs
                    const inputsRev = sm.data.map((_, i) => `
                        <input data-type="sm-rev" data-idx="${i}" value="${sm.inputRev[i] || ''}" type="tel" pattern="[0-9]*" maxlength="1" 
                        class="number-box rev w-full aspect-[3/4] text-xl md:text-2xl text-center font-bold bg-white border-2 border-slate-100 text-orange-600 focus:border-orange-500 focus:ring-4 focus:ring-orange-500/20"
                        ${isResult ? 'disabled' : ''}>
                    `).join('');

                    html = `
                    <div class="max-w-4xl mx-auto w-full animate-fade-in pb-20">
                        <div class="flex justify-between items-center mb-6 px-2">
                            <button onclick="goHome()" class="flex items-center gap-2 text-slate-400 font-bold text-sm hover:text-slate-800 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                Tho√°t
                            </button>
                            <div class="bg-white border border-slate-200 px-3 py-1.5 rounded-xl shadow-sm">
                                <span class="text-xs font-bold text-slate-400 uppercase mr-1.5 tracking-tighter">Level</span>
                                <span class="text-primary-600 font-black text-lg">${sm.count}</span>
                            </div>
                        </div>

                        <div class="flex flex-col items-center gap-6">
                            
                            <!-- Ph·∫ßn Nh·∫≠p Xu√¥i -->
                            <div class="w-full max-w-2xl bg-blue-50/50 rounded-2xl p-4 border border-blue-100 relative ${smFeedback.status==='wrong' && !smFeedback.fwd ? 'ring-2 ring-red-200 bg-red-50' : ''}">
                                <div class="absolute -top-3 left-4 bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider">
                                    1. Nh·∫≠p Xu√¥i ‚û°Ô∏è
                                </div>
                                <div class="grid grid-cols-10 gap-1.5 md:gap-3 mt-2">
                                    ${inputsFwd}
                                </div>
                            </div>

                            <!-- Ph·∫ßn Nh·∫≠p Ng∆∞·ª£c -->
                            <div class="w-full max-w-2xl bg-orange-50/50 rounded-2xl p-4 border border-orange-100 relative ${smFeedback.status==='wrong' && !smFeedback.rev ? 'ring-2 ring-red-200 bg-red-50' : ''}">
                                <div class="absolute -top-3 left-4 bg-orange-100 text-orange-700 text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider">
                                    2. Nh·∫≠p Ng∆∞·ª£c ‚¨ÖÔ∏è
                                </div>
                                <div class="grid grid-cols-10 gap-1.5 md:gap-3 mt-2">
                                    ${inputsRev}
                                </div>
                            </div>

                            ${fbHtml}
                        </div>
                    </div>`;
                }
            }

            else if (activeView === 'lm_cfg') {
                html = `
                <div class="bg-white rounded-3xl shadow-xl border border-slate-100 p-8 max-w-md mx-auto w-full animate-slide-up mt-4">
                    <h2 class="text-2xl font-extrabold text-slate-900 mb-8">C·∫•u h√¨nh b√†i t·∫≠p</h2>
                    <div class="space-y-6">
                        <div class="group">
                            <label class="text-xs font-bold text-slate-400 uppercase block mb-2 tracking-wider group-focus-within:text-primary-600 transition-colors">Th·ªùi gian nh·ªõ (ph√∫t)</label>
                            <input id="lm-mem" type="number" value="5" min="1" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-2xl font-bold text-slate-800 focus:bg-white focus:border-primary-600 outline-none text-xl transition-all">
                        </div>
                        <div class="group">
                            <label class="text-xs font-bold text-slate-400 uppercase block mb-2 tracking-wider group-focus-within:text-primary-600 transition-colors">Th·ªùi gian tr·∫£ l·ªùi (ph√∫t)</label>
                            <input id="lm-ans" type="number" value="5" min="1" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-2xl font-bold text-slate-800 focus:bg-white focus:border-primary-600 outline-none text-xl transition-all">
                        </div>
                        <div class="group">
                            <label class="text-xs font-bold text-slate-400 uppercase block mb-2 tracking-wider group-focus-within:text-primary-600 transition-colors">S·ªë l∆∞·ª£ng d√≤ng (40 s·ªë/d√≤ng)</label>
                            <input id="lm-cnt" type="number" value="2" min="1" max="50" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-2xl font-bold text-slate-800 focus:bg-white focus:border-primary-600 outline-none text-xl transition-all">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-10">
                        <button onclick="goHome()" class="py-4 rounded-2xl font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 transition-colors">H·ªßy b·ªè</button>
                        <button onclick="startLM()" class="py-4 rounded-2xl font-bold text-white bg-primary-600 hover:bg-primary-700 shadow-lg shadow-primary-100 transition-all active:scale-95">B·∫Øt ƒë·∫ßu ngay</button>
                    </div>
                </div>`;
            }

            else if (activeView === 'lm_mem') {
                const rows = lm.lines.map((line, i) => `
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 mb-4 shadow-sm active:scale-[0.99] transition-transform group">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center gap-2">
                                <span class="bg-slate-100 text-slate-500 px-3 py-1 rounded-lg text-[10px] font-extrabold uppercase tracking-tighter">D√≤ng ${i + 1}</span>
                            </div>
                            <div onclick="toggleMask(${i})" class="flex items-center gap-2 cursor-pointer">
                                ${lm.mask[i] ? '<span class="text-[10px] font-bold text-primary-500 flex items-center gap-1"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/></svg> ƒê√£ che</span>' : '<span class="text-[10px] font-bold text-slate-300">Nh·∫•n ƒë·ªÉ che</span>'}
                            </div>
                        </div>
                        
                        <div class="w-full overflow-x-auto no-scrollbar" onclick="toggleMask(${i})">
                            <div id="row-${i}" class="font-mono text-base md:text-2xl text-slate-800 leading-none tracking-[0.25em] whitespace-nowrap pt-2 pb-2 transition-all duration-300 select-none ${lm.mask[i] ? 'blur-content' : ''} cursor-pointer">
                                ${line}
                            </div>
                        </div>
                    </div>
                `).join('');

                html = `
                <div class="flex flex-col h-full max-w-4xl mx-auto w-full animate-fade-in">
                    <div class="sticky top-16 z-20 bg-slate-50/90 backdrop-blur-md pb-4 pt-2 border-b border-slate-200 mb-4">
                        <div class="flex gap-3 px-1">
                            <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex-1 flex justify-between items-center">
                                <div>
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-widest">Th·ªùi gian nh·ªõ</div>
                                    <div id="timer" class="font-mono text-2xl font-black text-slate-800">${fmtTime(lm.timer)}</div>
                                </div>
                                <button onclick="lmPhase2()" class="bg-primary-600 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-md active:scale-95 transition-all">Tr·∫£ l·ªùi ngay</button>
                            </div>
                            <button onclick="goHome()" class="bg-white text-slate-400 w-14 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-center hover:text-red-500 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 space-y-1 overflow-y-auto px-1 pb-10">${rows}</div>
                </div>`;
            }

            else if (activeView === 'lm_ans') {
                const rows = lm.inputs.map((_, r) => `
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 mb-4 shadow-sm group focus-within:border-primary-200 transition-all">
                        <div class="flex justify-between items-center mb-3 px-1">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">D√≤ng ${r + 1}</span>
                            <span id="prog-${r}" class="text-[10px] font-bold text-slate-300 transition-colors">0/40</span>
                        </div>
                        <div class="grid grid-cols-10 md:grid-cols-20 gap-1 md:gap-2">
                            ${Array(40).fill('').map((_, c) => `
                                <input data-type="lm" data-r="${r}" data-c="${c}" value="${lm.inputs[r][c] || ''}" type="tel" pattern="[0-9]*" maxlength="1"
                                class="number-box w-full aspect-square text-center font-mono text-sm md:text-lg font-bold bg-slate-50 border-2 border-transparent text-slate-900 focus:bg-white focus:border-primary-600 rounded-lg">
                            `).join('')}
                        </div>
                    </div>
                `).join('');

                html = `
                <div class="flex flex-col h-full max-w-4xl mx-auto w-full animate-fade-in">
                    <div class="sticky top-16 z-20 bg-slate-50/90 backdrop-blur-md pb-4 pt-2 border-b border-slate-200 mb-4">
                        <div class="flex gap-3 px-1">
                            <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex-1 flex justify-between items-center">
                                <div>
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-widest">C√≤n l·∫°i</div>
                                    <div id="timer" class="font-mono text-2xl font-black text-slate-800">${fmtTime(lm.timer)}</div>
                                </div>
                                <button onclick="lmScore()" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-md active:scale-95 transition-all">N·ªôp b√†i</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto px-1 pb-20">${rows}</div>
                </div>`;
            }

            else if (activeView === 'lm_res') {
                let totalC = 0, totalT = 0;
                const details = lm.lines.map((line, i) => {
                    const u = lm.inputs[i].join('');
                    totalT += 40;
                    let ls = 0; 
                    if(i < lm.lines.length - 1) { 
                        let d = Math.abs(line.length - u.length);
                        for(let k=0; k<Math.min(line.length, u.length); k++) if(u[k]!==line[k]) d++;
                        if(d===0) ls=40; else if(d===1) ls=20;
                    } else { 
                        let d = 0, len = u.trim().length;
                        for(let k=0; k<Math.min(len, line.length); k++) if(u[k]!==line[k]) d++;
                        if(d===0 && len>0) ls=len; else if(d===1 && len>0) ls=Math.ceil(len/2);
                    }
                    totalC += ls;

                    let comparisonHtml = '';
                    for (let k = 0; k < line.length; k++) {
                        const charU = u[k] || '';
                        if (charU === line[k]) comparisonHtml += `<span class="char-correct">${line[k]}</span>`;
                        else if (charU === '') comparisonHtml += `<span class="char-missing">${line[k]}</span>`;
                        else comparisonHtml += `<span class="char-incorrect">${line[k]}</span>`;
                    }

                    return `
                    <div class="bg-white p-6 rounded-3xl border border-slate-100 mb-6 shadow-sm">
                        <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-50">
                            <span class="text-xs font-black text-slate-400 uppercase tracking-widest">D√≤ng ${i + 1}</span>
                            <span class="px-3 py-1 rounded-full text-xs font-bold ${ls === 40 ? 'bg-green-50 text-green-600' : 'bg-slate-50 text-slate-400'}">${ls}/40 ƒëi·ªÉm</span>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-2">ƒê√°p √°n g·ªëc</label>
                                <div class="font-mono text-lg tracking-[0.2em] text-slate-300 break-all select-all">${line}</div>
                            </div>
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-2">ƒê·ªëi chi·∫øu (Sai ƒë·ªè - ƒê√∫ng xanh)</label>
                                <div class="font-mono text-lg tracking-[0.2em] break-all p-4 bg-slate-50 rounded-2xl">${comparisonHtml}</div>
                            </div>
                        </div>
                    </div>`;
                }).join('');

                const pct = totalT > 0 ? Math.round((totalC / totalT) * 100) : 0;
                const statusColor = pct >= 80 ? 'text-green-600' : pct >= 50 ? 'text-blue-600' : 'text-red-600';

                html = `
                <div class="max-w-3xl mx-auto w-full pb-20 animate-slide-up">
                    <div class="bg-white p-10 rounded-[2.5rem] border border-slate-100 shadow-xl text-center mb-8 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-2 ${pct >= 80 ? 'bg-green-500' : statusColor.replace('text', 'bg')}"></div>
                        <h2 class="text-xs font-black text-slate-400 uppercase tracking-[0.3em] mb-4">K·∫øt qu·∫£ b√†i t·∫≠p</h2>
                        <div class="text-8xl font-black ${statusColor} mb-2 tracking-tighter">${pct}%</div>
                        <div class="text-slate-500 font-bold text-xl mb-10">${totalC} / ${totalT} ƒëi·ªÉm t·ªïng</div>
                        <div class="flex flex-col sm:flex-row justify-center gap-4">
                            <button onclick="goHome()" class="px-8 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200 transition-all">V·ªÅ trang ch·ªß</button>
                            <button onclick="startLM()" class="px-8 py-4 bg-primary-600 text-white rounded-2xl font-bold shadow-lg shadow-primary-200 hover:bg-primary-700 transition-all">L√†m l·∫°i b√†i n√†y</button>
                        </div>
                    </div>
                    ${details}
                </div>`;
            }

            app.innerHTML = html;
        }

        // --- NAVIGATION & ACTIONS ---

        function goHome() {
            stopTimer();
            if(smTimer) clearTimeout(smTimer);
            if(smCountdownTimer) clearTimeout(smCountdownTimer);
            if(lm.countdownTimer) clearTimeout(lm.countdownTimer);
            activeView = 'home';
            render();
        }

        // --- SHORT MEMORY LOGIC ---

        function startSM() {
            sm.count = 2;
            sm.streak = 0;
            smCountdown = 3;
            activeView = 'sm_countdown';
            startSMCountdown();
        }

        function startSMCountdown() {
            render();
            if (smCountdown > 0) {
                smCountdownTimer = setTimeout(() => {
                    smCountdown--;
                    startSMCountdown();
                }, 1000);
            } else {
                skipSMCountdown();
            }
        }

        function skipSMCountdown() {
            clearTimeout(smCountdownTimer);
            genSM();
        }

        function genSM() {
            if(smTimer) clearTimeout(smTimer);
            smFeedback = { fwd: null, rev: null, status: '' }; 
            smShow = true;
            activeView = 'sm_play';
            sm.data = Array.from({length: sm.count}, () => Math.floor(Math.random() * 10));
            
            // Reset c·∫£ 2 m·∫£ng nh·∫≠p li·ªáu
            sm.inputFwd = Array(sm.count).fill('');
            sm.inputRev = Array(sm.count).fill('');
            
            render();
            
            const wait = Math.max(1200, sm.count * 500);
            smTimer = setTimeout(() => {
                smShow = false; 
                render();
                setTimeout(() => {
                    const el = document.querySelector('input[data-type="sm-fwd"][data-idx="0"]');
                    if(el) el.focus();
                }, 100);
            }, wait);
        }

        function checkSM() {
            const uFwd = sm.inputFwd.join('');
            const uRev = sm.inputRev.join('');
            
            const correctFwd = sm.data.join('');
            const correctRev = sm.data.slice().reverse().join('');

            const isFwdCorrect = uFwd === correctFwd;
            const isRevCorrect = uRev === correctRev;

            smFeedback.fwd = isFwdCorrect;
            smFeedback.rev = isRevCorrect;

            // Ph·∫£i ƒë√∫ng C·∫¢ HAI m·ªõi t√≠nh l√† th·∫Øng
            if (isFwdCorrect && isRevCorrect) {
                smFeedback.status = 'correct';
                sm.streak++;
                if (sm.streak > sm.best) {
                    sm.best = sm.streak;
                    localStorage.setItem('mp_best_sm', sm.best);
                }
                render();
                setTimeout(() => {
                    sm.count += 2;
                    genSM();
                }, 1500);
            } else {
                smFeedback.status = 'wrong';
                sm.streak = 0;
                render();
            }
        }

        // --- LONG MEMORY LOGIC ---

        function configLM() {
            activeView = 'lm_cfg';
            render();
        }

        function startLM() {
            const memVal = parseInt(document.getElementById('lm-mem').value);
            const ansVal = parseInt(document.getElementById('lm-ans').value);
            const cntVal = parseInt(document.getElementById('lm-cnt').value);

            lm.config.mem = isNaN(memVal) || memVal < 1 ? 5 : memVal;
            lm.config.ans = isNaN(ansVal) || ansVal < 1 ? 5 : ansVal;
            lm.config.cnt = isNaN(cntVal) || cntVal < 1 ? 2 : cntVal;

            lm.lines = Array(lm.config.cnt).fill().map(() => 
                Array.from({length: 40}, () => Math.floor(Math.random() * 10)).join('')
            );
            lm.mask = {};
            lm.countdown = 3;
            activeView = 'lm_countdown';
            startLMCountdown();
        }

        function startLMCountdown() {
            render();
            if (lm.countdown > 0) {
                lm.countdownTimer = setTimeout(() => {
                    lm.countdown--;
                    startLMCountdown();
                }, 1000);
            } else {
                skipLMCountdown();
            }
        }

        function skipLMCountdown() {
            clearTimeout(lm.countdownTimer);
            beginLMMemoryPhase();
        }

        function beginLMMemoryPhase() {
            activeView = 'lm_mem';
            lm.timer = lm.config.mem * 60;
            render();
            startTimer(() => lmPhase2());
        }

        function toggleMask(i) {
            lm.mask[i] = !lm.mask[i];
            render();
        }

        function lmPhase2() {
            stopTimer();
            activeView = 'lm_ans';
            lm.inputs = Array(lm.config.cnt).fill().map(() => Array(40).fill(''));
            lm.timer = lm.config.ans * 60;
            render();
            startTimer(() => lmScore());
        }

        function lmScore() {
            stopTimer();
            activeView = 'lm_res';
            render();
        }

        function startTimer(cb) {
            stopTimer();
            lm.timerId = setInterval(() => {
                lm.timer--;
                const el = document.getElementById('timer');
                if (el) {
                    el.innerText = fmtTime(lm.timer);
                    if (lm.timer < 30) el.classList.add('text-red-500', 'animate-pulse');
                }
                if (lm.timer <= 0) {
                    stopTimer();
                    cb();
                }
            }, 1000);
        }

        function stopTimer() {
            if (lm.timerId) clearInterval(lm.timerId);
        }

        // --- GLOBAL EVENT LISTENERS ---

        document.addEventListener('input', e => {
            const t = e.target;
            
            // SM Input (C·∫£ Xu√¥i v√† Ng∆∞·ª£c)
            if (t.dataset.type === 'sm-fwd' || t.dataset.type === 'sm-rev') {
                const i = parseInt(t.dataset.idx);
                const isFwd = t.dataset.type === 'sm-fwd';
                
                // L∆∞u gi√° tr·ªã v√†o m·∫£ng t∆∞∆°ng ·ª©ng
                if (isFwd) sm.inputFwd[i] = t.value;
                else sm.inputRev[i] = t.value;

                // T·ª± ƒë·ªông focus √¥ ti·∫øp theo trong c√πng nh√≥m
                if (t.value && i < sm.count - 1) {
                    const selector = `input[data-type="${t.dataset.type}"][data-idx="${i + 1}"]`;
                    document.querySelector(selector)?.focus();
                }

                // Ki·ªÉm tra n·∫øu ƒë√£ nh·∫≠p ƒë·ªß C·∫¢ HAI m·∫£ng
                const fullFwd = sm.inputFwd.filter(x => x !== '').length === sm.count;
                const fullRev = sm.inputRev.filter(x => x !== '').length === sm.count;
                
                if (fullFwd && fullRev) {
                    checkSM();
                }
            }
            
            // LM Input
            if (t.dataset.type === 'lm') {
                const r = parseInt(t.dataset.r);
                const c = parseInt(t.dataset.c);
                lm.inputs[r][c] = t.value;
                
                const filled = lm.inputs[r].filter(x => x !== '').length;
                const p = document.getElementById(`prog-${r}`);
                if (p) {
                    p.innerText = `${filled}/40`;
                    if (filled === 40) p.classList.add('text-green-500');
                    else p.classList.remove('text-green-500');
                }
                
                if (t.value) {
                    if (c < 39) {
                        document.querySelector(`input[data-r="${r}"][data-c="${c + 1}"]`)?.focus();
                    } else if (r < lm.config.cnt - 1) {
                        document.querySelector(`input[data-r="${r + 1}"][data-c="0"]`)?.focus();
                    }
                }
            }
        });

        // H·ªó tr·ª£ x√≥a l√πi (Backspace)
        document.addEventListener('keydown', e => {
            if (e.key === 'Backspace') {
                const t = e.target;
                
                // SM Backspace
                if ((t.dataset.type === 'sm-fwd' || t.dataset.type === 'sm-rev') && !t.value) {
                    const i = parseInt(t.dataset.idx);
                    if (i > 0) {
                        const selector = `input[data-type="${t.dataset.type}"][data-idx="${i - 1}"]`;
                        document.querySelector(selector)?.focus();
                    }
                }

                // LM Backspace
                if (t.dataset.type === 'lm' && !t.value) {
                    const r = parseInt(t.dataset.r);
                    const c = parseInt(t.dataset.c);
                    if (c > 0) {
                        document.querySelector(`input[data-r="${r}"][data-c="${c - 1}"]`)?.focus();
                    } else if (r > 0) {
                        document.querySelector(`input[data-r="${r - 1}"][data-c="39"]`)?.focus();
                    }
                }
            }
        });

        // Kh·ªüi t·∫°o app
        render();

    </script>
</body>
</html>
